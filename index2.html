<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Simple Accounting</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
:root{
  --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb; --primary:#111827; --accent:#111827;
}
body.theme-light{--bg:#f6f7fb;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#111827}
body.theme-dark{--bg:#0b1020;--card:#0f172a;--text:#e5e7eb;--muted:#94a3b8;--line:#1e293b;--accent:#22d3ee}
body.theme-blue{--bg:#f6f8ff;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#e5e7eb;--accent:#2563eb}
body.theme-gray{--bg:#f5f5f5;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#e5e7eb;--accent:#374151}
body.theme-red{--bg:#fff7f7;--card:#ffffff;--text:#111827;--muted:#6b7280;--line:#f3d6d6;--accent:#dc2626}
body.theme-green{--bg:#f3fbf6;--card:#ffffff;--text:#0f172a;--muted:#64748b;--line:#d8efe1;--accent:#059669}

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:"Noto Sans Khmer", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--card);z-index:10}
.brand{font-weight:700}
.row{display:flex;align-items:center}.gap{gap:8px}.between{justify-content:space-between}.right{text-align:right}.bold{font-weight:700}
.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:10px 14px}
.tab{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer}
.tab.active{background:var(--accent);color:#fff;border-color:transparent}
.view{display:none;padding:14px}.view.active{display:block}
.card{background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(2,6,23,.06);padding:14px;margin-bottom:14px}
.card.light{background:rgba(2,6,23,.03)}
.input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff;width:100%}
.input.sm{width:auto;min-width:120px}
.small{font-size:12px}.muted{color:var(--muted)}
.link{background:none;border:none;color:#2563eb;cursor:pointer;padding:0}
.btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;transition:.2s}
.btn:hover{opacity:.95;transform:translateY(-1px)}
.btn.ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
.btn.danger{color:#dc2626;border:1px solid #dc2626;background:transparent}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-top:1px solid var(--line);text-align:left;vertical-align:top}
.grid.two{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.grid.three{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.grid.four{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.stat{background:rgba(2,6,23,.04);border:1px dashed var(--line);padding:10px;border-radius:12px}
.stat-title{font-size:12px;color:var(--muted)}.stat-val{font-weight:700}
.error{color:#dc2626;font-size:13px}

/* Modal */
.modal.hidden{display:none}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;padding:16px;z-index:50}
.modal-card{background:var(--card);color:var(--text);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:16px;max-width:700px;width:100%}

/* Toast */
.toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%) scale(.96);background:var(--accent);color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s;z-index:60}
.toast.show{opacity:1;transform:translateX(-50%) scale(1)}

.btn.mode-active{background:var(--accent);color:#fff;border-color:transparent}
#mode-hint{margin-left:6px}

input[readonly]{background:rgba(2,6,23,.04); cursor:not-allowed;}

.stat .stat-val{font-size:18px}



#dash-kpi .stat{background:rgba(2,6,23,.04)} #dash-kpi .k{font-size:12px;color:var(--muted)} #dash-kpi .v{font-size:20px;font-weight:700}

/* === Print styles for exporting the Report as PDF === */
@media print {
  /* Hide everything by default */
  body * { visibility: hidden; }
  /* When printing explicitly from our button, show only the report view */
  body.print-report-only #view-report, 
  body.print-report-only #view-report * {
    visibility: visible;
  }
  body.print-report-only #view-report {
    position: absolute;
    left: 0; top: 0;
    width: 100%;
    margin: 0; padding: 0;
  }
  /* Optional: hide buttons/controls marked no-print */
  .no-print { display: none !important; }
}



tr.low-stock { background: #ffe8e8 !important; }

/* === QMI enhancements (injected) === */
#quick-money h3 { font-size:18px; font-weight:700; }
#qmi-balances .chip { background: rgba(2,6,23,.05); padding:6px 10px; border-radius:8px; font-weight:600; }
.table th { background: var(--line); font-weight:600; }

/* Login Modal */
#login-modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 100; }
#login-modal.hidden { display: none; }
#login-card { background: var(--card); border-radius: 16px; padding: 32px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,.3); }
#login-card h2 { margin: 0 0 24px 0; text-align: center; }
#login-card label { display: block; margin-bottom: 8px; font-weight: 600; }
#login-card select, #login-card input { margin-bottom: 16px; }
#login-card .btn { width: 100%; margin-top: 8px; }
#login-error { color: #dc2626; font-size: 13px; margin-top: 8px; text-align: center; display: none; }
#login-error.show { display: block; }
#current-user { font-size: 12px; color: var(--muted); margin-right: 12px; }
#logout-btn { padding: 6px 12px; font-size: 12px; }
/* Hide main app until authenticated */
body:not(.authenticated) header.topbar,
body:not(.authenticated) nav.tabs,
body:not(.authenticated) .view { display: none !important; }
body.authenticated #login-modal { display: none !important; }

</style>
</head>
<body>
  <!-- Login Modal -->
  <div id="login-modal">
    <div id="login-card">
      <h2>üîê Login</h2>
      <label for="login-role">Role</label>
      <select id="login-role" class="input">
        <option value="">Select Role</option>
        <option value="ADMIN">ADMIN</option>
        <option value="HR">HR</option>
        <option value="SALE">SALE</option>
        <option value="DELIVERY">DELIVERY</option>
      </select>
      <label for="login-pin">PIN</label>
      <input id="login-pin" type="password" class="input" placeholder="Enter PIN" maxlength="10"/>
      <button id="login-btn" class="btn">Login</button>
      <div id="login-error" class="error">Incorrect PIN. Please try again.</div>
    </div>
  </div>

  <header class="topbar">
    <div class="brand">üíº <span data-i18n="app_name">Simple Accounting</span></div>
    <div class="row gap">
      <span id="current-user" style="display:none;"></span>
      <button id="logout-btn" class="btn ghost" style="display:none;">Logout</button>
      <select id="themeSelect" class="input sm" title="Theme">
        <option value="light">üå§Ô∏è Light</option>
        <option value="dark">üåô Dark</option>
        <option value="blue">üíô Blue</option>
        <option value="gray">üñ§ Gray</option>
        <option value="red">‚ù§Ô∏è Red</option>
        <option value="green">üíö Green</option>
      </select>
      <select id="langSelect" class="input sm" title="Language">
        <option value="km">·ûÅ·üí·ûò·üÇ·ûö</option>
        <option value="en">English</option>
      </select>
      <button id="btnExport" class="btn ghost" data-i18n="export">Export</button>
      <label for="importFile" class="btn ghost" data-i18n="import">Import</label>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
      <button id="btnReset" class="btn danger ghost" data-i18n="reset">Reset</button>
    </div>
    <div class="row gap" id="extra-nav" style="display:none"><button class="btn ghost" data-view="report-all">üìä <span data-i18n="report_all">Reports (All)</span></button></div>
</header>

  <nav class="tabs">
    <button class="tab" data-view="dashboard">üìä <span>Dashboard</span></button>
    <button class="tab active" data-view="sales">üßæ <span data-i18n="tab_sales">Sales</span></button>
    <button class="tab" data-view="products">üì¶ <span data-i18n="tab_products">Products</span></button>
    <button class="tab" data-view="customers">üë• <span data-i18n="tab_customers">Customers</span></button>
    <button class="tab" data-view="invoices">üìÑ <span data-i18n="tab_invoices">Invoices</span></button>
    <button class="tab" data-view="report">üìà <span data-i18n="tab_report">Report</span></button>
  </nav>

  <section id="view-sales" class="view active">
    <div class="card">
      <h2>üßæ <span data-i18n="new_invoice">New Invoice</span></h2>
<div class="row gap" style="margin-bottom:8px">
  <span class="small muted">Mode:</span>
  <button id="mode-sale" class="btn ghost">SALE</button>
  <button id="mode-resell" class="btn ghost">RESELL</button>
  <span class="small muted" id="mode-hint">Items auto-use SALE price</span>
</div>
      <div class="grid four">
        <div>
          <label data-i18n="customer">Customer</label>
          <div class="row gap"><input id="s-customer" class="input" list="s-customer-list" placeholder="Type name/phone/location..."/> <datalist id="s-customer-list"></datalist> <input type="hidden" id="s-customer-id"/>
            <button id="btnCustomerNew" class="btn ghost" data-i18n="new">New</button>
          </div>
          <div id="s-cust-info" class="small muted"></div>
        </div>
        <div>
          <label data-i18n="seller">Seller</label>
          <input id="s-seller" class="input" placeholder="Name"/>
        </div>
        <div>
          <label data-i18n="branch">Branch</label>
          <input id="s-branch" class="input" placeholder="Main"/>
        </div>
        <div>
          <label data-i18n="invoice_type">Invoice Type</label>
          <select id="s-type" class="input">
            <option value="SALE" data-i18n="sale">SALE</option>
            <option value="RESELL" data-i18n="resell">RESELL</option>
          </select>
        </div>
      </div>

      <div class="card light">
        <div class="row between">
          <b data-i18n="items">Items</b>
          <div class="row gap">
            <input id="barcode" class="input sm" placeholder="Scan/Type barcode" />
            <button id="add-item" class="btn ghost">+ <span data-i18n="add">Add</span></button>
          </div>
        </div>
        <table class="table" id="items">
          <thead>
            <tr>
              <th data-i18n="product">Product</th>
              <th data-i18n="type" style="display:none">Type</th>
              <th data-i18n="qty">Qty</th>
              <th data-i18n="cost">·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã·ûî·ûì·üí·ûè</th>
              <th data-i18n="price">·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã</th>
              <th data-i18n="line_total">Line Total</th>
              <th data-i18n="profit">Profit</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr><td colspan="6" class="right"><span data-i18n="subtotal_sale_qty">Subtotal (SALE √ó Qty)</span></td><td id="subAmount" class="right">$ 0.00</td></tr>
            <tr><td colspan="6" class="right"><span data-i18n="profit_subtotal">Profit Subtotal</span></td><td id="subProfit" class="right muted">+ $ 0.00</td></tr>
            <tr>
              <td colspan="4" class="right" data-i18n="discount"><span data-i18n="discount_sale">Discount (SALE)</span></td>
              <td colspan="2">
                <div class="row gap">
                  <select id="disc-type" class="input sm"><option value="amt">$</option><option value="pct">%</option></select>
                  <input id="disc" type="number" step="0.01" value="0" class="input sm"/>
                </div>
              </td>
              <td id="disc-amt" class="right muted">- $ 0.00</td>
            </tr>
            <tr>
              <td colspan="6" class="right bold"><span data-i18n="total_sale_minus_discount">TOTAL (Subtotal ‚àí Discount)</span></td>
              <td class="bold right">
                <div class="row gap" style="justify-content:flex-end">
                  <span id="grand" style="align-self:center">$ 0.00</span>
                  <input id="grand-in" class="input sm" type="number" step="0.01" min="0" title="Type desired total to auto-calc discount" placeholder="Type total"/>
                </div>
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card light">
        <div class="row between"><b data-i18n="payments">Payments</b><button id="add-payment" class="btn ghost">+ <span data-i18n="add">Add</span></button></div>
        <table class="table" id="payments">
          <thead><tr><th data-i18n="method">Method</th><th data-i18n="amount">Amount</th><th></th></tr></thead>
          <tbody></tbody>
          <tfoot>
            <tr><td class="right" data-i18n="paid">Paid</td><td id="paid"></td><td></td></tr>
            <tr><td class="right" data-i18n="balance">Balance</td><td id="balance" class="bold"></td><td></td></tr>
          </tfoot>
        </table>
        <div class="row gap" style="margin-top:8px">
          <button id="save" class="btn">üíæ <span data-i18n="save_invoice">Save Invoice</span></button>
          <button id="print" class="btn ghost">üñ®Ô∏è <span data-i18n="download_pdf">Download PDF</span></button>
          <span id="s-error" class="error"></span>
        </div>
      </div>
    </div><!-- removed sales summary grid three --><div id="sm-sales" class="stat-val">$ 0.00</div></div>
        <div class="stat"><div class="stat-title">Total Profit</div><div id="sm-profit" class="stat-val">+ $ 0.00</div></div>
        <div class="stat"><div class="stat-title">Invoices</div><div id="sm-count" class="stat-val">0</div></div>
      </div>
      <!-- removed sales-tab By Customer card -->

  <div class="row gap">
        <label class="small muted">Month</label>
      </div>
      <div class="row gap">
  <label class="small muted">Type</label>
  <select id="filter-type" class="input sm">
    <option value="ALL">ALL</option>
    <option value="SALE">SALE</option>
    <option value="RESELL">RESELL</option>
  </select>
</div>
    </div>

    </div>
  </div>

</section>

<section id="view-dashboard" class="view">
    <div class="card">
      <h2>üìä Dashboard</h2>
      <div class="grid four gap" id="dash-kpi" style="margin-top:10px"></div>
    <div class="card" id="quick-money" style="margin-top:12px">
      <div class="row gap" style="flex-wrap:wrap">
        <div>
          <label class="small">Type</label>
          <select id="qmi-type" class="input"><option value="IN">IN</option><option value="OUT">OUT</option></select>
        </div>
        <div>
          <label class="small">Destination</label>
          <select id="qmi-dest" class="input"><option value="CASH">Cash</option><option value="ABA">ABA</option><option value="ACLEDA">ACLEDA</option></select>
        </div>
        <div>
          <label class="small">Transfer To (optional)</label>
          <select id="qmi-to" class="input"><option value="">‚Äî</option><option value="CASH">Cash</option><option value="ABA">ABA</option><option value="ACLEDA">ACLEDA</option></select>
        </div>
        <div>
          <label class="small">Currency</label>
          <select id="qmi-curr" class="input"><option value="KHR">KHR (·üõ)</option><option value="USD">USD ($)</option></select>
        </div>
        <div>
          <label class="small">Amount</label>
          <input id="qmi-amount" class="input" type="number" step="0.01" min="0" placeholder="0.00"/>
        </div>
        <div class="grow">
          <label class="small">Note</label>
          <input id="qmi-note" class="input" placeholder="Optional note (e.g., deposit #, who paid)"/>
        </div>
        <div style="align-self:end">
          <button id="qmi-add" class="btn">Add</button>
        </div>
      </div>
      <div class="small muted" style="margin-top:6px">Quick record of money-in to Cash or Bank.</div>
      <div id="qmi-balances" class="row gap" style="margin-top:10px"></div>
      <table class="mt">
        <thead><tr><th>Date</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead>
        <tbody id="qmi-table"></tbody>
      </table>
    </div>
    
    </div>

    <div class="card light">
      <div class="row between">
        <b>Filters</b>
        <div class="small muted">Set what you want to see ‚Äî then Apply</div>
      </div>
      <div class="grid four">
        <div>
          <label>Date From</label>
          <input id="d-from" type="date" class="input" data-remember />
        </div>
        <div>
          <label>Date To</label>
          <input id="d-to" type="date" class="input" data-remember />
        </div>
        <div>
          <label>Type</label>
          <select id="d-type" class="input" data-remember>
            <option value="ALL">ALL</option>
            <option value="SALE">SALE</option>
            <option value="RESELL">RESELL</option>
          </select>
        </div>
        <div>
          <label>Branch</label>
          <input id="d-branch" class="input" placeholder="Any" data-remember />
        </div>
      </div>
      <div class="grid four" style="margin-top:8px">
        <div>
          <label>Seller</label>
          <input id="d-seller" class="input" placeholder="Name..." data-remember />
        </div>
        <div>
          <label>Customer</label>
          <input id="d-customer" class="input" placeholder="Name/Phone/Location..." data-remember />
        </div>
        <div>
          <label>Product keyword</label>
          <input id="d-product" class="input" placeholder="Find in invoice items..." data-remember />
        </div>
        <div style="align-self:end">
          <button id="d-apply" class="btn">Apply</button>
          <button id="d-clear" class="btn ghost">Clear</button>
        </div>
      </div>
    </div>

    <div class="card light" id="dash-filter-sums" style="margin-top:10px;">
      <div class="row between">
        <b>Totals (Filtered)</b>
        <div class="row gap">
          <div><span class="small muted">Total Qty</span> <b id="d-sum-sales">$ 0.00</b></div>
          <div><span class="small muted">Total Profit</span> <b id="d-sum-profit">$ 0.00</b></div>
        </div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="row between">
          <b>Recent Invoices</b>
          <span id="d-inv-count" class="small muted">0 found</span>
        </div>
        <table class="table" id="d-invoices">
          <thead><tr>
            <th>#</th><th>Date/Time</th><th>No.</th><th>Customer</th><th>Seller</th><th>Branch</th><th class="right">Qty</th><th class="right">Qty</th><th class="right">Total</th><th class="right">Profit</th><th class="right">Status</th>
          </tr></thead>
          <tbody></tbody>
        </table>
        <div id="d-inv-sums" class="small" style="margin-top:6px; text-align:right;"><b>Total Sales:</b> $ 0.00 &nbsp; ¬∑ &nbsp; <b>Total Profit:</b> $ 0.00</div>
      </div>

      <div class="card">
        <div class="row between">
          <b>Top Products (by sales)</b>
          <span id="d-top-count" class="small muted">0</span>
        </div>
        <table class="table" id="d-top">
          <thead><tr>
            <th>Product</th><th class="right">Qty</th><th class="right">Sales</th><th class="right">Profit</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="card light">
      <b>Stock Alerts</b>
      <table class="table" id="d-stock">
        <thead><tr><th>Product</th><th class="right">Qty</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>


  <section id="view-products" class="view">
    <div class="card">
      <div class="row between">
        <h2>üì¶ <span data-i18n="products">Products</span></h2>
        <div class="row gap">
          <input id="p-search" class="input" placeholder="Search..." />
          <label class="small">·ûü·üí·ûè·ûª·ûÄ ‚â§</label>
          <input id="p-threshold" class="input sm" type="number" step="1" min="0" value="0"/>
          <label class="small"><input type="checkbox" id="p-low-only"/> ·ûè·üÇ·ûü·üí·ûè·ûª·ûÄ·ûë·û∂·ûî</label>
          <button id="p-add" class="btn">+ <span data-i18n="add_product">Add Product</span></button>
        </div>
      </div>
      <table class="table" id="p-table">
        <thead><tr>
          <th data-i18n="product">Product</th>
          <th>Barcode</th>
          <th data-i18n="sale_price">SALE</th>
          <th data-i18n="resell_price">RESELL</th>
          <th data-i18n="cost">·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã·ûî·ûì·üí·ûè</th>
          <th data-i18n="qty">Qty</th>
          <th>Low Stock</th>
          <th></th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="view-customers" class="view">
    <div class="card">
      <div class="row between">
        <h2>üë• <span data-i18n="customers">Customers</span></h2>
        <div class="row gap"><input id="c-search" class="input" placeholder="..." /><button id="c-new" class="btn">+ <span data-i18n="new_customer">Customer</span></button></div>
      </div>
      <table class="table" id="c-table"><thead><tr><th data-i18n="name">Name</th><th data-i18n="phone">Phone</th><th data-i18n="location">Location</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  <section id="view-invoices" class="view">
    <div class="card">
      <div class="row between">
        <h2>üìÑ <span data-i18n="invoices">Invoices</span></h2>
        <div class="row gap">
          <input id="inv-search" class="input" placeholder="# / customer / seller / branch" />
          <select id="inv-status" class="input sm">
            <option value="ALL">All</option>
            <option value="PAID">PAID</option>
            <option value="UNPAID">UNPAID</option>
          </select>
          <button class="btn ghost invfilter" data-f="ALL">All</button>
          <button class="btn ghost invfilter" data-f="SALE">SALE</button>
          <button class="btn ghost invfilter" data-f="RESELL">RESELL</button>
        </div>
      </div>
      <div class="small">Sort: <button class="link" data-sort="date">Date</button> ¬∑ <button class="link" data-sort="total">Total</button> ¬∑ <button class="link" data-sort="status">Status</button></div>
      <table class="table" id="inv-table"><thead><tr><th>#</th><th data-i18n="date">Date</th><th>No.</th><th data-i18n="seller">·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã</th><th data-i18n="branch">·ûü·û∂·ûÅ·û∂</th><th data-i18n="status">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th><th data-i18n="total">Total</th><th data-i18n="paid">·ûî·û∂·ûì·ûî·ûÑ·üã</th><th data-i18n="balance">·ûì·üÖ·ûü·ûõ·üã</th><th>Action</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </section>

  
  <section id="view-report" class="view" style="display:none;">
    <h2>üìä Report</h2>
    <div class="row gap no-print" style="margin:12px 0;">
      <label>Month: <input type="month" id="r-month"></label>
      <label>Type:
        <select id="r-type">
          <option value="ALL">All</option>
          <option value="SALE">Sale</option>
          <option value="RETURN">Return</option>
          <option value="PAID">Paid</option>
          <option value="UNPAID">Unpaid</option>
        </select>
      </label>
      <button id="btn-export-pdf" class="btn">Export to PDF</button>
    </div>
    <canvas id="chart" width="640" height="300" style="max-width:100%;"></canvas>
    <h3>Payment Summary</h3>
    <table class="tbl" id="payments-summary">
      <thead><tr><th>Method</th><th>Amount</th></tr></thead>
      <tbody></tbody>
    </table>
    <h3>Report by Customer</h3>
    <table class="tbl" id="report-by-customer">
      <thead><tr><th>Customer</th><th>Total</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>


  <div id="modal-mask" class="modal hidden">
    <div class="modal-card">
      <h3 id="m-title">Modal</h3>
      <div id="m-body"></div>
      <div class="row gap" style="margin-top:10px">
        <button id="m-save" class="btn" data-i18n="save">Save</button>
        <button id="m-cancel" class="btn ghost" data-i18n="cancel">Cancel</button>
        <span id="m-error" class="error"></span>
      </div>
    </div>
  </div>

  <script>
// Simple Accounting ‚Äî Clean Fixed Edition
const NS = 'sa_clean_v1_';
const K = (k)=> NS+k;
const read = (k,f)=>{ try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
const write=(k,v)=>localStorage.setItem(K(k), JSON.stringify(v));
// Session storage for login (clears when tab closes)
const readSession = (k,f)=>{ try{return JSON.parse(sessionStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
const writeSession=(k,v)=>sessionStorage.setItem(K(k), JSON.stringify(v));
const uid = ()=> Math.random().toString(36).slice(2);
const money = (n)=>'$ '+(Math.round((Number(n)||0)*100)/100).toFixed(2);
const byId = (id)=>document.getElementById(id);
let LOW_STOCK_THRESHOLD = read('low_threshold',5);

// Login Credentials
const LOGIN_CREDENTIALS = {
  ADMIN: '9630',
  HR: '1122',
  SALE: '8899',
  DELIVERY: '4455'
};

// Current user state (stored in sessionStorage - clears when tab closes)
let CURRENT_USER_ROLE = readSession('current_user_role', null);

// Authentication functions
function checkLogin() {
  return CURRENT_USER_ROLE !== null && CURRENT_USER_ROLE in LOGIN_CREDENTIALS;
}

function login(role, pin) {
  if (role && LOGIN_CREDENTIALS[role] === pin) {
    CURRENT_USER_ROLE = role;
    writeSession('current_user_role', role);
    hideLoginModal();
    showMainApp();
    updateUserDisplay();
    // Initialize sales tab after login (if no saved tab)
    setTimeout(() => {
      const savedTab = readSession('active_tab');
      if (!savedTab && typeof switchTab === 'function') {
        switchTab('sales');
      } else if (savedTab && typeof switchTab === 'function') {
        switchTab(savedTab);
      }
    }, 100);
    return true;
  }
  return false;
}

function logout() {
  CURRENT_USER_ROLE = null;
  writeSession('current_user_role', null);
  showLoginModal();
  hideMainApp();
  updateUserDisplay();
}

function hideLoginModal() {
  const modal = byId('login-modal');
  if (modal) modal.classList.add('hidden');
}

function showLoginModal() {
  const modal = byId('login-modal');
  if (modal) modal.classList.remove('hidden');
  const pinInput = byId('login-pin');
  if (pinInput) pinInput.value = '';
  const errorDiv = byId('login-error');
  if (errorDiv) errorDiv.classList.remove('show');
}

function hideMainApp() {
  document.body.classList.remove('authenticated');
}

function showMainApp() {
  document.body.classList.add('authenticated');
  // Tab restoration happens after all handlers are set up (see below after switchTab definition)
}

function updateUserDisplay() {
  const userSpan = byId('current-user');
  const logoutBtn = byId('logout-btn');
  if (userSpan && logoutBtn) {
    if (CURRENT_USER_ROLE) {
      userSpan.textContent = `Role: ${CURRENT_USER_ROLE}`;
      userSpan.style.display = 'block';
      logoutBtn.style.display = 'block';
    } else {
      userSpan.style.display = 'none';
      logoutBtn.style.display = 'none';
    }
  }
}

// Initialize login on page load - wait for DOM
function initLogin() {
  if (!checkLogin()) {
    showLoginModal();
    hideMainApp();
  } else {
    hideLoginModal();
    showMainApp();
    updateUserDisplay();
  }

  // Login button handler
  const loginBtn = byId('login-btn');
  if (loginBtn) {
    loginBtn.onclick = () => {
      const role = byId('login-role').value;
      const pin = byId('login-pin').value;
      const errorDiv = byId('login-error');
      
      if (!role) {
        if (errorDiv) {
          errorDiv.textContent = 'Please select a role';
          errorDiv.classList.add('show');
        }
        return;
      }
      
      if (login(role, pin)) {
        if (errorDiv) errorDiv.classList.remove('show');
      } else {
        if (errorDiv) {
          errorDiv.textContent = 'Incorrect PIN. Please try again.';
          errorDiv.classList.add('show');
        }
        const pinInput = byId('login-pin');
        if (pinInput) pinInput.value = '';
      }
    };
    
    // Allow Enter key to login
    const pinInput = byId('login-pin');
    if (pinInput) {
      pinInput.onkeypress = (e) => {
        if (e.key === 'Enter') loginBtn.click();
      };
    }
  }

  // Logout button handler
  const logoutBtn = byId('logout-btn');
  if (logoutBtn) {
    logoutBtn.onclick = () => {
      if (confirm('Are you sure you want to logout?')) {
        logout();
      }
    };
  }
}

// Wait for DOM to be ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initLogin);
} else {
  initLogin();
}

const valById = (id)=>{ const el = document.getElementById(id); return el? (el.value??'').toString() : ''; };

// Global sale/resell mode
let CURRENT_MODE = 'SALE'; // 'SALE' || 'RESELL'

// Method labels (for Payments & Report)
const METHOD_LABELS = {
  CASH_KHR: 'Cash (KHR)',
  CASH_USD: 'Cash (USD)',
  BANK_ABA_KHR: 'Bank ABA (KHR)',
  BANK_ABA_USD: 'Bank ABA (USD)',
  BANK_ACLEDA_KHR: 'Bank ACLEDA (KHR)',
  BANK_ACLEDA_USD: 'Bank ACLEDA (USD)',
  MOBILE_MONEY: 'Mobile Money',
  OTHER: 'Other'
};

// Initial data
['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang'].forEach(k=>{ if(read(k,null)===null){ write(k, (k==='invSeq' || k==='invSeqSale' || k==='invSeqResell')?0:(k==='theme'?'light':(k==='lang'?'km':[]))); } });

// i18n
const I18N = {
  km: { app_name:'·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûÇ·ûé·ûì·üÅ·ûô·üí·ûô·ûü·û∂·ûò·ûâ·üí·ûâ', export:'·ûì·û∂·üÜ·ûÖ·üÅ·ûâ', import:'·ûì·û∂·üÜ·ûÖ·ûº·ûõ', reset:'·ûÄ·üÜ·ûé·ûè·üã·û°·ûæ·ûÑ·ûú·û∑·ûâ',
    tab_sales:'·ûõ·ûÄ·üã', tab_products:'·ûë·üÜ·ûì·û∑·ûâ', tab_customers:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', tab_invoices:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', tab_report:'·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç',
    new_invoice:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö‚Äã·ûê·üí·ûò·û∏', customer:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', new:'·ûê·üí·ûò·û∏', seller:'·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã', branch:'·ûü·û∂·ûÅ·û∂', invoice_type:'·ûî·üí·ûö·ûó·üÅ·ûë·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö',
    sale:'·ûõ·ûÄ·üã·ûö·û∂·ûô', resell:'·ûõ·ûÄ·üã·ûî·ûì·üí·ûè', items:'·ûí·û∂·ûè·ûª', add:'·ûî·ûì·üí·ûê·üÇ·ûò', product:'·ûë·üÜ·ûì·û∑·ûâ', type:'·ûî·üí·ûö·ûó·üÅ·ûë', qty:'·ûÖ·üÜ·ûì·ûΩ·ûì', price:'·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã', cost:'·ûè·ûò·üí·ûõ·üÉ·ûä·ûæ·ûò',
    line_total:'·ûè·ûò·üí·ûõ·üÉ SALE', profit:'·ûÖ·üÜ·ûé·üÅ·ûâ', discount:'·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ', payments:'·ûÄ·û∂·ûö·ûî·ûÑ·üã·ûî·üí·ûö·û∂·ûÄ·üã', method:'·ûú·û∑·ûí·û∏', amount:'·ûÖ·üÜ·ûì·ûΩ·ûì',
    paid:'·ûî·û∂·ûì·ûî·ûÑ·üã', balance:'·ûì·üÖ·ûü·ûõ·üã', save_invoice:'·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', download_pdf:'·ûë·û∂·ûâ·ûô·ûÄ PDF',
    products:'·ûë·üÜ·ûì·û∑·ûâ', add_product:'·ûî·ûì·üí·ûê·üÇ·ûò·ûë·üÜ·ûì·û∑·ûâ', sale_price:'·ûè·ûò·üí·ûõ·üÉ SALE', resell_price:'·ûè·ûò·üí·ûõ·üÉ RESELL', status:'·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ',
    customers:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', new_customer:'·û¢·ûè·û∑·ûê·û∑·ûá·ûì', name:'·ûà·üí·ûò·üÑ·üá', phone:'·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë', location:'·ûë·û∏·ûè·û∂·üÜ·ûÑ',
    invoices:'·ûú·û∑·ûÄ·üí·ûÄ·ûô·ûî·ûè·üí·ûö', date:'·ûê·üí·ûÑ·üÉ·ûÅ·üÇ', report:'·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç', month:'·ûÅ·üÇ', total_sales:'·ûü·ûö·ûª·ûî·ûÄ·û∂·ûö·ûõ·ûÄ·üã', total_profit:'·ûü·ûö·ûª·ûî·ûÖ·üÜ·ûé·üÅ·ûâ',
    save:'·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ', cancel:'·ûî·üÑ·üá·ûî·ûÑ·üã' , subtotal_sale_qty:'·ûü·ûö·ûª·ûî (·ûè·ûò·üí·ûõ·üÉ SALE √ó ·ûÖ·üÜ·ûì·ûΩ·ûì)', profit_subtotal:'·ûÖ·üÜ·ûé·üÅ·ûâ·ûü·ûö·ûª·ûî', discount_sale:'·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ (·ûõ·ûæ SALE)', total_sale_minus_discount:'·ûü·ûö·ûª·ûî·ûÖ·ûª·ûÑ·ûÄ·üí·ûö·üÑ·ûô (·ûü·ûö·ûª·ûî ‚àí ·ûî·ûâ·üí·ûÖ·ûª·üá·ûè·ûò·üí·ûõ·üÉ)'},
  en: { app_name:'Simple Accounting', export:'Export', import:'Import', reset:'Reset',
    tab_sales:'Sales', tab_products:'Products', tab_customers:'Customers', tab_invoices:'Invoices', tab_report:'Report',
    new_invoice:'New Invoice', customer:'Customer', new:'New', seller:'Seller', branch:'Branch', invoice_type:'Invoice Type',
    sale:'SALE', resell:'RESELL', items:'Items', add:'Add', product:'Product', type:'Type', qty:'Qty', price:'Price', cost:'Cost',
    line_total:'SALE Price', profit:'Profit', discount:'Discount', payments:'Payments', method:'Method', amount:'Amount',
    paid:'Paid', balance:'Balance', save_invoice:'Save Invoice', download_pdf:'Download PDF',
    products:'Products', add_product:'Add Product', sale_price:'SALE', resell_price:'RESELL', status:'Status',
    customers:'Customers', new_customer:'Customer', name:'Name', phone:'Phone', location:'Location',
    invoices:'Invoices', date:'Date', report:'Report', month:'Month', total_sales:'Total Sales', total_profit:'Total Profit',
    save:'Save', cancel:'Cancel' , subtotal_sale_qty:'Subtotal (SALE √ó Qty)', profit_subtotal:'Profit Subtotal', discount_sale:'Discount (on SALE)', total_sale_minus_discount:'TOTAL (Subtotal ‚àí Discount)'}
};
function applyI18n(){
  const lang = read('lang','km');
  document.documentElement.lang = (lang==='km'?'km':'en');
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    const txt = I18N[lang][key] || key;
    el.textContent = txt;
  });
}
const langSelect = byId('langSelect'); langSelect.value = read('lang','km');
langSelect.onchange = ()=>{ write('lang', langSelect.value); applyI18n(); };

// Theme
const themeSelect = byId('themeSelect'); themeSelect.value = read('theme','light');
function applyTheme(){ const t = read('theme','light'); document.body.className = ''; document.body.classList.add('theme-'+t); }
themeSelect.onchange = ()=>{ write('theme', themeSelect.value); applyTheme(); };
applyTheme(); applyI18n();

// Toast
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.classList.add('show'),10); setTimeout(()=>{t.classList.remove('show'); setTimeout(()=>t.remove(),200);},2000); }

// Mode toggle UI
const modeSaleBtn = document.getElementById('mode-sale');
const modeResellBtn = document.getElementById('mode-resell');
function applyModeUI(){
  if (!modeSaleBtn || !modeResellBtn) return;
  modeSaleBtn.classList.toggle('mode-active', CURRENT_MODE==='SALE');
  modeResellBtn.classList.toggle('mode-active', CURRENT_MODE==='RESELL');
  const hint = document.getElementById('mode-hint');
  if (hint) hint.textContent = CURRENT_MODE==='SALE' ? 'Items auto-use SALE price' : 'Items auto-use RESELL price';
}
if (modeSaleBtn){ modeSaleBtn.onclick = ()=>{ CURRENT_MODE='SALE'; applyModeUI(); try{ recalc && recalc(); }catch(e){} } }
if (modeResellBtn){ modeResellBtn.onclick = ()=>{ CURRENT_MODE='RESELL'; applyModeUI(); try{ recalc && recalc(); }catch(e){} } }


function syncRow(tr){
  const sel = tr.querySelector('.sel-prod'); const opt = sel && sel.selectedOptions ? sel.selectedOptions[0] : null;
  const type = tr.querySelector('.sel-type') ? tr.querySelector('.sel-type').value : (CURRENT_MODE || 'SALE');
  if (!opt){ tr.querySelector('.price').value = '0.00'; tr.querySelector('.cost').value = '0.00'; tr.querySelector('.stock').textContent='Stock: -'; return; }
  const ds = opt.dataset || {};
  const sale = Number(ds.sale || 0);
  const resell = Number(ds.resell || 0);
  const cost = Number(ds.cost || 0);
  const stock = Number(ds.stock || 0);
  tr.querySelector('.price').value = sale.toFixed(2); // editable
  const baseline = Number(tr.querySelector('.cost')?.value || 0);
  tr.querySelector('.cost').value = (baseline||0).toFixed(2); // readonly
  const stockEl = tr.querySelector('.stock'); stockEl.textContent = 'Stock: ' + (isNaN(stock)? '-' : stock); if(!isNaN(stock)) { stockEl.classList.toggle('muted', stock<=LOW_STOCK_THRESHOLD); }
}

function recalc(){
  let subtotal = 0, profitTotal = 0;
  document.querySelectorAll('#items tbody tr').forEach(tr=>{
    const qty = Number(tr.querySelector('.qty')?.value || 0);
    const price = Number(tr.querySelector('.price')?.value || 0);
    const baseline = Number(tr.querySelector('.cost')?.value || 0);
    const line = Math.round(qty*price*100)/100;
    const p = Math.round(qty*(price - baseline)*100)/100;
    tr.querySelector('.line').textContent = money(line);
    tr.querySelector('.linep').textContent = (p>=0?'+ ':'- ')+money(Math.abs(p));
    subtotal = Math.round((subtotal + line)*100)/100;
    profitTotal = Math.round((profitTotal + p)*100)/100;
  });
  let d = Number(byId('disc')?.value || 0);
  if (byId('disc-type') && byId('disc-type').value==='pct'){
    d = Math.round(subtotal*(d/100)*100)/100;
    if (d>subtotal) d=subtotal;
  }
  const total = Math.max(0, Math.round((subtotal - d)*100)/100);
  let paid = 0;
  document.querySelectorAll('.pay-amt').forEach(i=> paid += Number(i.value||0));
  paid = Math.round(paid*100)/100;
  const bal = Math.max(0, Math.round((total - paid)*100)/100);

  byId('disc-amt').textContent = '- '+money(d);
  byId('grand').textContent = money(total);
  byId('paid').textContent = money(paid);
  byId('balance').textContent = money(bal);
  const sp = byId('subProfit'); if (sp) sp.textContent = (profitTotal>=0?'+ ':'- ')+money(Math.abs(profitTotal));
  const sa = byId('subAmount'); if (sa) sa.textContent = money(subtotal);
}
// Tabs
function switchTab(viewName) {
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  
  const tabBtn = document.querySelector(`.tab[data-view="${viewName}"]`);
  const viewEl = document.getElementById('view-'+viewName);
  
  if (tabBtn && viewEl) {
    tabBtn.classList.add('active');
    viewEl.classList.add('active');
    writeSession('active_tab', viewName);
    
    if (viewName==='report') { drawReport(); paymentsSummary(getReportMonth()); }
    if (viewName==='invoices') renderInvoices();
    if (viewName==='products') renderProducts();
    if (viewName==='customers') renderCustomers();
    if (viewName==='sales') bindSales();
    if (viewName==='dashboard') { initDashboard(); }
  }
}

document.querySelectorAll('.tab').forEach(btn=>{
  btn.onclick=()=>{ switchTab(btn.dataset.view); };
});

// Restore active tab on page load (after all handlers are set up)
if (checkLogin()) {
  setTimeout(() => {
    const savedTab = readSession('active_tab', 'sales');
    if (savedTab && typeof switchTab === 'function') {
      switchTab(savedTab);
    }
  }, 100);
}

// Export / Import / Reset
byId('btnExport').onclick = ()=>{
  const data = {}; ['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang'].forEach(k=>data[k]=read(k,null));
  const a = document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:'application/json'})); a.download='simple_accounting_backup.json'; a.click();
  toast('Exported backup.json');
};
byId('importFile').onchange = async (e)=>{
  const f = e.target.files?.[0]; if (!f) return; const txt = await f.text();
  try{ const d = JSON.parse(txt); for (const k of ['products','customers','invoices','invSeq','theme','lang']){ if (d[k]!==undefined) write(k,d[k]); } toast('Imported'); } catch { toast('Invalid JSON'); }
  e.target.value=''; renderProducts(); renderCustomers(); renderInvoices(); bindSales(); drawReport(); paymentsSummary(getReportMonth()); reportByCustomer(getReportMonth());
};
byId('btnReset').onclick = ()=>{
  // Password-protected Reset / Clear History - Admin only
  if (CURRENT_USER_ROLE !== 'ADMIN') {
    alert('Only ADMIN users can reset the system.');
    return;
  }
  const pw = prompt('Enter admin PIN to confirm Reset / Clear History:');
  if (pw === null) return; // user cancelled
  if (pw !== LOGIN_CREDENTIALS.ADMIN){
    alert('Incorrect PIN');
    return;
  }
  const full = confirm('Full Reset?\nOK = Full Reset (delete ALL data and settings)\nCancel = Clear History (keep products/customers/settings)');
  if (full){
    ['products','customers','invoices','invSeq','invSeqSale','invSeqResell','theme','lang','ledger','qmi','low_threshold','low_filter'].forEach(k=>localStorage.removeItem(K(k)));
    toast('Full reset completed');
  } else {
    ['invoices','ledger','qmi','invSeq','invSeqSale','invSeqResell'].forEach(k=> localStorage.removeItem(K(k)));
    toast('History cleared (products/customers/settings kept)');
  }
  setTimeout(()=> location.reload(), 300);
};

// Customers
function renderCustomers(){
  const list = read('customers',[]);
  const q = (byId('c-search').value||'').toLowerCase();
  const show = list.filter(c=> (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q) || (c.location||'').toLowerCase().includes(q));
  const tbody = document.querySelector('#c-table tbody');
  tbody.innerHTML = (show.length? show: list).map(c=>'<tr><td>'+ (c.name||'') +'</td><td>'+ (c.phone||'') +'</td><td>'+ (c.location||'') +'</td><td><button class="btn ghost" data-edit="'+c.id+'">Edit</button> <button class="btn ghost" data-del="'+c.id+'">Del</button></td></tr>').join('') || '<tr><td colspan="4">No data</td></tr>';
  tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> openCustomerModal(b.dataset.edit));
  tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=> { if(!confirm('Delete customer?')) return; write('customers', read('customers').filter(x=>x.id!==b.dataset.del)); renderCustomers(); bindSales(); });
}
document.getElementById('c-search').oninput = renderCustomers;
document.getElementById('c-new').onclick = ()=> openCustomerModal();
function openCustomerModal(id){
  const m = document.getElementById('modal-mask');
  document.getElementById('m-error').textContent='';
  document.getElementById('m-title').textContent = id? 'Edit Customer' : 'New Customer';
  const c = id? read('customers',[]).find(x=>x.id===id) : {name:'',phone:'',location:''};
  document.getElementById('m-body').innerHTML = '<div class="grid three"><input id="cm-name" class="input" placeholder="Name" value="'+(c?.name||'')+'"/><input id="cm-phone" class="input" placeholder="Phone" value="'+(c?.phone||'')+'"/><input id="cm-location" class="input" placeholder="Location" value="'+(c?.location||'')+'"/></div>';
  m.classList.remove('hidden');
  document.getElementById('m-cancel').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-save').onclick = ()=>{
    const name = valById('cm-name').trim(); if(!name){ document.getElementById('m-error').textContent='Enter name'; return; }
    const phone = valById('cm-phone').trim(); const location = valById('cm-location').trim();
    const list = read('customers',[]);
    if (id){ const i = list.findIndex(x=>x.id===id); if(i>=0) list[i] = {...list[i], name, phone, location}; }
    else { list.push({id:uid(), name, phone, location}); }
    write('customers', list); m.classList.add('hidden'); renderCustomers(); bindSales();
  };
}

// Products
function renderProducts(){
  const list = read('products',[]);
  const q = (byId('p-search').value||'').toLowerCase();
  let low = LOW_STOCK_THRESHOLD;
  const lowOnly = (byId('p-low-only') && byId('p-low-only').checked) || read('low_filter', false);
  let show = list.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.barcode||'').toLowerCase().includes(q) );
  if (lowOnly) { show = show.filter(p=> Number(p.qty||0) <= Number(p.low_threshold ?? LOW_STOCK_THRESHOLD)); }
  const tbody = document.querySelector('#p-table tbody');
  
  tbody.innerHTML = (show.length? show:list).map(p=>{
return `<tr class="${(p.qty||0)<=Number(p.low_threshold ?? LOW_STOCK_THRESHOLD) ? 'low-stock' : ''}"><td>${p.name}</td><td>${p.barcode||''}</td><td>${money(p.price_sale||0)}</td><td>${money(p.price_resell||0)}</td><td>${money(p.cost||0)}</td><td>${p.qty||0}</td><td>${(p.qty||0)<=Number(p.low_threshold ?? LOW_STOCK_THRESHOLD) ? 'üî¥ LOW' : '‚úÖ OK'}</td><td><button class="btn ghost" data-edit="${p.id}">Edit</button> <button class="btn ghost" data-del="${p.id}">Del</button></td></tr>`;
  }).join('') || '<tr><td colspan="8">No data</td></tr>';
  tbody.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{ if(!confirm('Delete product?')) return; write('products', read('products').filter(x=>x.id!==b.dataset.del)); renderProducts(); });
  tbody.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=> openProductModal(b.dataset.edit));
}
document.getElementById('p-search').oninput = renderProducts;
// Low stock controls init
const pThreshold = byId('p-threshold');
if (pThreshold){ pThreshold.value = LOW_STOCK_THRESHOLD; pThreshold.oninput = ()=>{ LOW_STOCK_THRESHOLD = Math.max(0, Math.floor(Number(pThreshold.value||0))); write('low_threshold', LOW_STOCK_THRESHOLD); renderProducts(); }; }
const pLowOnly = byId('p-low-only');
if (pLowOnly){ pLowOnly.checked = read('low_filter', false); pLowOnly.onchange = ()=>{ write('low_filter', pLowOnly.checked); renderProducts(); }; }

document.getElementById('p-add').onclick = ()=> openProductModal();
function openProductModal(id){
  const m = document.getElementById('modal-mask'); const p = id? read('products',[]).find(x=>x.id===id) : {name:'', price_sale:0, price_resell:0, cost:0, qty:0, barcode:''};
  document.getElementById('m-error').textContent='';
  document.getElementById('m-title').textContent = id? 'Edit Product' : 'New Product';
  document.getElementById('m-body').innerHTML = '<div class="grid four"><input id="pm-name" class="input" placeholder="Name *" value="'+(p?.name||'')+'"/><input id="pm-barcode" class="input" placeholder="Barcode" value="'+(p?.barcode||'')+'"/><input id="pm-sale" type="number" step="0.01" class="input" placeholder="PRICE *" value="'+(p?.price_sale||0)+'"/><input id="pm-resell" type="number" step="0.01" class="input" placeholder="RESELL *" value="'+(p?.price_resell||0)+'"/></div><div class="grid three" style="margin-top:8px"><input id="pm-cost" type="number" step="0.01" class="input" placeholder="COST *" value="'+(p?.cost||0)+'"/><input id="pm-qty" type="number" step="1" class="input" placeholder="QTY *" value="'+(p?.qty||0)+'"/><input id="pm-low" type="number" step="1" class="input" placeholder="Low threshold" value="'+(p?.low_threshold??LOW_STOCK_THRESHOLD)+'"/><div class="small muted" style="align-self:center">Profit = price - cost</div></div>'
  m.classList.remove('hidden');
  document.getElementById('m-cancel').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-save').onclick = ()=>{
    const name = document.getElementById('pm-name').value.trim(); if(!name) { document.getElementById('m-error').textContent='Enter name'; return; }
    const item = {
      id: id || uid(),
      name,
      barcode: document.getElementById('pm-barcode').value.trim(),
      price_sale: Number(document.getElementById('pm-sale').value||0),
      price_resell: Number(document.getElementById('pm-resell').value||0),
      cost: Number(document.getElementById('pm-cost').value||0),
      qty: Math.max(0, Math.floor(Number(document.getElementById('pm-qty').value||0))),
      low_threshold: Math.max(0, Math.floor(Number(document.getElementById('pm-low').value||LOW_STOCK_THRESHOLD)))
    };
    const list = read('products',[]);
    if (id){ const i = list.findIndex(x=>x.id===id); if(i>=0) list[i] = item; }
    else { list.push(item); }
    write('products', list); m.classList.add('hidden'); renderProducts(); bindSales();
  };
}

// Sales



function bindSales(){
  const thCost = document.querySelector('#items thead th[data-i18n="cost"]');
  if (thCost) thCost.textContent = '·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã·ûî·ûì·üí·ûè';
  const thPrice = document.querySelector('#items thead th[data-i18n="price"]');
  if (thPrice) thPrice.textContent = '·ûè·ûò·üí·ûõ·üÉ·ûõ·ûÄ·üã';
  if (typeof applyModeUI==='function') applyModeUI();

  // Ensure containers exist
  const itemsBodyLocal = document.querySelector('#items tbody');
  if (!itemsBodyLocal) return;

  // --- Customer input + datalist ---
  const custInput  = byId('s-customer');
  const custHidden = byId('s-customer-id');
  const custList   = byId('s-customer-list');
  const custInfo   = byId('s-cust-info');
  const btnCustNew = byId('btnCustomerNew');
  if (btnCustNew) btnCustNew.onclick = ()=> openCustomerModal();
  

  const allCustomers = read('customers', []);

  function renderCustomerList(q=''){
    const t = (q||'').toLowerCase();
    const filtered = !t ? allCustomers : allCustomers.filter(c=>
      (c.name||'').toLowerCase().includes(t) || (c.phone||'').toLowerCase().includes(t) || (c.location||'').toLowerCase().includes(t)
    );
    if (custList){
      custList.innerHTML = filtered.slice(0,100).map(c=>
        `<option value="${(c.name||'(No name)')}${c.phone?(' ¬∑ '+c.phone):''}${c.location?(' ¬∑ '+c.location):''}"></option>`
      ).join('');
    }
  }

  function bestMatch(text){
    const t = (text||'').trim().toLowerCase(); if(!t) return null;
    const exact = allCustomers.find(c=> (c.name||'').toLowerCase()===t || (c.phone||'').toLowerCase()===t);
    if (exact) return exact;
    const starts = allCustomers.filter(c=> (c.name||'').toLowerCase().startsWith(t) || (c.phone||'').toLowerCase().startsWith(t) || (c.location||'').toLowerCase().startsWith(t));
    if (starts.length===1) return starts[0];
    const contains = allCustomers.filter(c=> ((c.name||'')+' '+(c.phone||'')+' '+(c.location||'')).toLowerCase().includes(t));
    if (contains.length===1) return contains[0];
    return null;
  }

  function showInfo(c){
    if (!custInfo) return;
    custInfo.textContent = c ? `üìû ${c.phone||'-'}  ¬∑  üìç ${c.location||'-'}` : '';
  }

  renderCustomerList('');

  if (allCustomers.length && custInput && !custInput.value){
    custInput.value = allCustomers[0].name || '';
    custHidden && (custHidden.value = allCustomers[0].id || '');
    showInfo(allCustomers[0]);
  }

  if (custInput){
    custInput.oninput = ()=>{
      renderCustomerList(custInput.value);
      const m = bestMatch(custInput.value);
      if (m){
        custHidden && (custHidden.value = m.id);
        showInfo(m);
      } else {
        custHidden && (custHidden.value = '');
        showInfo(null);
      }
    };
  }
}
// Add item row
  const itemsBody = document.querySelector('#items tbody');
const payBody = document.querySelector('#payments tbody');
function addItemRow(prodId){
    const tr = document.createElement('tr');
    const prods = read('products',[]);
    const prodOpts = prods.map(p=>{
      const sale = (p.sale ?? p.price_sale ?? p.price ?? 0);
      const resell = (p.resell ?? p.price_resell ?? 0);
      const cost = (p.cost ?? p.price_cost ?? p.cost_price ?? 0);
      const stock = (p.qty ?? p.stock ?? p.quantity ?? 0);
      const name = (p.name ?? p.title ?? '[no name]');
      const id = (p.id ?? p.sku ?? name);
      return `<option value="${id}" data-sale="${sale}" data-resell="${resell}" data-cost="${cost}" data-stock="${stock}">${name}</option>`;
    }).join('');
    tr.innerHTML = `
      <td>
        <select class="input sel-prod"><option value=""></option>${prodOpts}</select>
        <div class="small muted stock">Stock: -</div>
      </td>
      <td style="display:none">
        <select class="input sel-type"><option value="SALE">SALE</option><option value="RESELL">RESELL</option></select>
      </td>
      <td><input class="input qty" type="number" step="1" min="1" value="1"/></td>
      <td><input class="input cost" type="number" step="0.01" value="0.00"  title="Auto baseline"/></td>
      <td><input class="input price" type="number" step="0.01" value="0.00"/></td>
      <td class="line">$ 0.00</td>
      <td class="linep muted">+ $ 0.00</td>
      <td><button class="btn ghost del">Del</button></td>
    `;
    itemsBody.appendChild(tr);

    // Default mode
    const typeSel = tr.querySelector('.sel-type'); typeSel.value = CURRENT_MODE || 'SALE';

    // If prodId provided, select it
    const sel = tr.querySelector('.sel-prod');
    if (prodId) sel.value = prodId;
    // Sync immediately
    syncRow(tr);
    recalc();

    // Wiring
    sel.onchange = ()=>{ syncRow(tr); recalc(); };
    typeSel.onchange = ()=>{ syncRow(tr); recalc(); };
    tr.querySelector('.qty').oninput = ()=>{ const stockTxt = tr.querySelector('.stock')?.textContent||''; const m = stockTxt.match(/(\d+)/); const stock = m? Number(m[1]): NaN; let q = Number(tr.querySelector('.qty').value||0); if(!isNaN(stock) && q>stock){ q = stock; tr.querySelector('.qty').value = q; toast('Not enough stock'); } recalc(); };
    tr.querySelector('.price').oninput = recalc;
    tr.querySelector('.cost').oninput = recalc;
    tr.querySelector('.del').onclick = ()=>{ tr.remove(); recalc(); };
  }

  // Payment row
  function addPaymentRow(){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><select class="input pay-method">
        <option value="cash">$ Cash</option>
        <option value="cash-khr">KHR Cash</option>
        <option value="aba">$ ABA</option>
        <option value="aba-khr">KHR ABA</option>
        <option value="acleda">$ ACLEDA</option>
        <option value="acleda-khr">KHR ACLEDA</option>
      </select></td>
      <td><input class="input pay-amt" type="number" step="0.01" value="0.00"/></td>
      <td></td>`;
    (document.querySelector('#payments tbody')||payBody).appendChild(tr);
    tr.querySelector('.pay-amt').oninput = recalc;
  }

  // Add initial rows if empty
  if (!itemsBody.querySelector('tr')) addItemRow();
  if (!document.querySelector('#payments tbody tr')) addPaymentRow();

  
  // Discount listeners
  if (byId('disc')) byId('disc').oninput = ()=>{ const gi = byId('grand-in'); if (gi) gi.value=''; recalc(); };
  if (byId('disc-type')) byId('disc-type').onchange = ()=>{ const gi = byId('grand-in'); if (gi) gi.value=''; recalc(); };

  // Desired Total input -> compute discount automatically (amount mode)
  const grandIn = byId('grand-in');
  if (grandIn) grandIn.oninput = ()=>{
    const desired = Math.max(0, Number(grandIn.value||0));
    // compute current subtotal (SALE √ó Qty across rows)
    let subtotal = 0;
    document.querySelectorAll('#items tbody tr').forEach(tr=>{
      const qty = Number(tr.querySelector('.qty')?.value || 0);
      const price = Number(tr.querySelector('.price')?.value || 0);
      subtotal = Math.round((subtotal + qty*price)*100)/100;
    });
    let discAmt = Math.max(0, Math.round((subtotal - desired)*100)/100);
    // Switch to amount mode and set discount value
    if (byId('disc-type')) byId('disc-type').value = 'amt';
    if (byId('disc')) byId('disc').value = discAmt.toFixed(2);
    recalc();
  };
  recalc();
  // Expose
  window.addItemRow = addItemRow;
  window.addPaymentRow = addPaymentRow;


// --- Update product stock by subtracting sold quantities ---
function updateStock(items){
  if (!Array.isArray(items) || !items.length) return;
  const prods = read('products',[]) || [];
  const map = new Map(prods.map(p=>[(p.id ?? p.sku ?? p.name ?? ''), p]));
  items.forEach(it=>{
    const pid = it.productId || it.id || '';
    const p = map.get(pid);
    if (p){
      const cur = Number(p.qty ?? p.stock ?? 0);
      const next = Math.max(0, Math.round((cur - Number(it.qty||0))*100)/100);
      p.qty = next;
    }
  });
  write('products', prods);
}

// --- Save current sales form as an invoice ---
function buildInvoiceFromForm(){
  // Customer
  const customerId = (byId('s-customer-id')?.value || '').trim();
  const customerName = (byId('s-customer')?.value || '').trim();
  // Meta
  const seller = (byId('s-seller')?.value || '').trim();
  const branch = (byId('s-branch')?.value || '').trim();
  const invType = (byId('s-type')?.value || CURRENT_MODE || 'SALE');

  // Items
  const items = [];
  let subtotal = 0, profitTotal = 0;
  document.querySelectorAll('#items tbody tr').forEach(tr=>{
    const prodOpt = tr.querySelector('.sel-prod')?.selectedOptions?.[0];
    const prodId = prodOpt ? prodOpt.value : '';
    const prodName = prodOpt ? prodOpt.textContent : '';
    const qty = Number(tr.querySelector('.qty')?.value || 0);
    const price = Number(tr.querySelector('.price')?.value || 0);
    const baseline = Number(tr.querySelector('.cost')?.value || 0);
    if (prodId && qty>0){
      const amount = Math.round(qty*price*100)/100;
      const profit = Math.round(qty*(price-baseline)*100)/100;
      items.push({productId:prodId, name:prodName, qty, price, baseline, amount, profit});
      subtotal = Math.round((subtotal + amount)*100)/100;
      profitTotal = Math.round((profitTotal + profit)*100)/100;
    }
  });

  // Discount
  let disc = Number(byId('disc')?.value || 0);
  const discType = byId('disc-type')?.value || 'amt';
  if (discType==='pct'){
    disc = Math.round(subtotal*(disc/100)*100)/100;
    if (disc>subtotal) disc=subtotal;
  }
  const total = Math.max(0, Math.round((subtotal - disc)*100)/100);

  // Payments
  const METHOD_MAP = {
    'cash':'CASH_USD',
    'cash-khr':'CASH_KHR',
    'aba':'BANK_ABA_USD',
    'aba-khr':'BANK_ABA_KHR',
    'acleda':'BANK_ACLEDA_USD',
    'acleda-khr':'BANK_ACLEDA_KHR'
  };
  const payments = [];
  let paid = 0;
  document.querySelectorAll('#payments tbody tr').forEach(tr=>{
    const val = (tr.querySelector('.pay-method')?.value || '').toLowerCase();
    const amt = Number(tr.querySelector('.pay-amt')?.value || 0);
    if (amt>0){
      const method = METHOD_MAP[val] || 'OTHER';
      payments.push({method, amount: Math.round(amt*100)/100});
      paid = Math.round((paid + amt)*100)/100;
    }
  });
  const balance = Math.max(0, Math.round((total - paid)*100)/100);
  const status = (paid>=total && total>0) ? 'PAID' : (paid>0 ? 'PARTIAL' : 'UNPAID');

  // Invoice number/sequence
  const seqKey = invType==='RESELL' ? 'invSeqResell' : 'invSeqSale';
  let seq = Number(read(seqKey,0) || 0) + 1;
  write(seqKey, seq);
  const invNo = (invType==='RESELL'?'R-':'S-') + String(seq).padStart(4,'0');

  // Build invoice object
  return {
    id: uid(),
    invNo,
    date: new Date().toISOString().slice(0,10),
    datetime: new Date().toISOString(),
    invType,
    customerId,
    customer: customerName,
    seller,
    branch,
    items,
    subtotal,
    discount: disc,
    total,
    payments,
    paid,
    balance,
    profit: profitTotal,
    status
  };
}

// Attach Save & Print handlers once on Sales bind
if (document.getElementById('save') && !document.getElementById('save')._bound){
  document.getElementById('save').onclick = (e)=>{
    if (e) e.preventDefault(); // Prevent any form submission or page refresh
    const custId = (byId('s-customer-id')?.value||'').trim();
    const custNm = (byId('s-customer')?.value||'').trim();
    if (!custNm){ byId('s-error').textContent='Enter customer first'; return false; }
    // If typed name not in list, we already offered quick-create on blur/Enter; ensure we have an id, else create now
    if (!custId){
      const list = read('customers',[]);
      let m = list.find(c=> (c.name||'').toLowerCase()===custNm.toLowerCase());
      if (!m){ m = {id: uid(), name: custNm, phone:'', location:''}; list.push(m); write('customers', list); }
      byId('s-customer-id').value = m.id;
    }
const inv = buildInvoiceFromForm();
    if (!inv.items.length){ byId('s-error').textContent = 'Add at least 1 item'; return false; }
    // Validate stock availability
    const prods = read('products',[])||[]; const map = new Map(prods.map(p=>[(p.id ?? p.sku ?? p.name ?? ''), Number(p.qty ?? p.stock ?? 0)]));
    for (const it of inv.items){ const have = map.get(it.productId)||0; if (it.qty>have){ byId('s-error').textContent='Not enough stock for '+(it.name||it.productId); return false; } }
    byId('s-error').textContent='';
    const list = read('invoices',[]);
    list.unshift(inv); // add to top
    write('invoices', list);
    updateStock(inv.items);
    toast('Saved: '+inv.invNo);
    
    // Clear form after saving (without refreshing page)
    const itemsBody = document.querySelector('#items tbody');
    if (itemsBody) itemsBody.innerHTML = '';
    const payBody = document.querySelector('#payments tbody');
    if (payBody) payBody.innerHTML = '';
    if (byId('s-customer')) byId('s-customer').value = '';
    if (byId('s-customer-id')) byId('s-customer-id').value = '';
    if (byId('s-seller')) byId('s-seller').value = '';
    if (byId('s-branch')) byId('s-branch').value = '';
    if (byId('disc')) byId('disc').value = '0';
    if (byId('disc-type')) byId('disc-type').value = 'amt';
    if (byId('s-cust-info')) byId('s-cust-info').textContent = '';
    
    // Re-initialize form
    renderProducts && renderProducts();
    bindSales && bindSales();
    renderInvoices && renderInvoices();
    return false;
  };
  document.getElementById('save')._bound = true;
}
if (document.getElementById('print') && !document.getElementById('print')._bound){
  document.getElementById('print').onclick = ()=>{
    const inv = buildInvoiceFromForm();
    // Do not persist; just open print view of the built invoice
    // Temporarily push then print then remove
    const list = read('invoices',[]);
    list.unshift(inv); write('invoices', list);
    try{ printInvoice && printInvoice(inv.id); } finally {
      // remove temp
      const cur = read('invoices',[]).filter(x=>x.id!==inv.id);
      write('invoices', cur);
    }
  };
  document.getElementById('print')._bound = true;
}




// Invoices
let INV_FILTER='ALL'; let INV_SORT={by:'date',dir:'desc'};
// Hook filter-type (Sales page small filter) to invoices list filter
(function(){
  const ft = document.getElementById('filter-type');
  if (ft && !ft._bound){
    ft.addEventListener('change', ()=>{
      INV_FILTER = ft.value || 'ALL';
      try { renderInvoices && renderInvoices(); } catch(e) {}
    });
    ft._bound = true;
  }
})();

function renderInvoices(){
  const invs = read('invoices',[]).map(i=> (i.datetime? i : {...i, datetime: (i.date? new Date(i.date+'T00:00:00').toISOString(): new Date().toISOString()) }));
  const q = (byId('inv-search').value||'').toLowerCase();
  const statusSel = byId('inv-status').value;
  let show = invs.filter(i=> INV_FILTER==='ALL'? true : (i.invType||'SALE')===INV_FILTER);
  if (statusSel!=='ALL') show = show.filter(i=> (i.status||((i.balance||0)>0?'UNPAID':'PAID'))===statusSel);
  if (q) show = show.filter(i=>{
    const hay = (i.invNo+' '+(i.customer||'')+' '+(i.customer_phone||'')+' '+(i.seller||'')+' '+(i.branch||'')+' '+(i.notes||'')).toLowerCase();
    return hay.includes(q);
  });
  show.sort((a,b)=>{ const dir = INV_SORT.dir==='asc'?1:-1;
    switch(INV_SORT.by){
      case 'total': return dir*((a.total||0)-(b.total||0));
      case 'status': return dir*((a.status||'').localeCompare(b.status||''));
      default: return dir*(new Date(a.datetime)-new Date(b.datetime));
    }
  });
  const tbody = document.querySelector('#inv-table tbody');
  tbody.innerHTML = show.map((i,idx)=>{
    const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
    const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
    return `<tr>
      <td>${idx+1}</td>
      <td>${new Date(i.datetime).toLocaleString()}</td>
      <td>${i.invNo||''}</td>
      <td>${i.seller||''}</td>
      <td>${i.branch||''}</td>
      <td>${status}</td>
      <td class="right">$ ${(i.total||0).toFixed(2)}</td>
      <td class="right">$ ${(i.paid||0).toFixed(2)}</td>
      <td class="right">$ ${bal.toFixed(2)}</td>
      <td><button class="btn ghost" data-print="${i.id}">Print</button></td><td><button class="btn ghost" data-view="${i.id}">View</button></td>
      <td><button class="btn ghost" data-paid="${i.id}">Mark Paid</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="11">No data</td></tr>';
  tbody.querySelectorAll('[data-print]').forEach(b=> b.onclick=()=> printInvoice(b.dataset.print));
  tbody.querySelectorAll('[data-view]').forEach(b=> b.onclick=()=> viewInvoice(b.dataset.view));
  tbody.querySelectorAll('[data-paid]').forEach(b=> b.onclick=()=> openMarkPaidModal(b.dataset.paid));
}

document.querySelectorAll('[data-sort]').forEach(b=> b.onclick=()=>{
  const by = b.dataset.sort;
  if (INV_SORT.by===by) INV_SORT = {by, dir:(INV_SORT.dir==='asc'?'desc':'asc')};
  else INV_SORT = {by, dir:'desc'};
  renderInvoices();
});
byId('inv-search').oninput = renderInvoices;
byId('inv-status').onchange = renderInvoices;
document.querySelectorAll('.invfilter').forEach(b=> b.onclick=()=>{ INV_FILTER = b.dataset.f; renderInvoices(); });

function openMarkPaidModal(invId){
  const list = read('invoices',[]);
  const idx  = list.findIndex(x=> x.id === invId);
  if (idx < 0){ toast('Invoice not found'); return; }
  const inv = list[idx];

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Mark as Paid';
  document.getElementById('m-error').textContent = '';

  document.getElementById('m-body').innerHTML = `
    <div class="grid two">
      <div>
        <label>Amount Paid</label>
        <input id="mp-amt" class="input" type="number" step="0.01" placeholder="0.00"/>
      </div>
      <div>
        <label>Method</label>
        <select id="mp-method" class="input">
          <option value="CASH_USD">Cash (USD)</option>
          <option value="CASH_KHR">Cash (KHR)</option>
          <option value="BANK_ABA_USD">ABA (USD)</option>
          <option value="BANK_ABA_KHR">ABA (KHR)</option>
          <option value="BANK_ACLEDA_USD">ACLEDA (USD)</option>
          <option value="BANK_ACLEDA_KHR">ACLEDA (KHR)</option>
          <option value="OTHER" selected>Other</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Note (optional)</label>
      <input id="mp-note" class="input" placeholder="e.g., ABA transfer ID / payer"/>
    </div>
    <div style="margin-top:8px">
      <label>Upload Slip / Photos (multiple)</label>
      <input id="mp-files" type="file" accept="image/*" multiple/>
    </div>
  `;
  // Set default amount = remaining balance
  document.getElementById('mp-amt').value = Math.max(0, (inv.total || 0) - (inv.paid || 0)).toFixed(2);

  const saveBtn = document.getElementById('m-save');
  const cancelBtn = document.getElementById('m-cancel');
  if (cancelBtn){ cancelBtn.onclick = ()=> m.classList.add('hidden'); }

  saveBtn.onclick = async ()=>{
    const amt    = Number(document.getElementById('mp-amt').value || 0);
    const method = document.getElementById('mp-method').value || 'OTHER';
    const note   = (document.getElementById('mp-note').value || '').trim();
    const files  = Array.from(document.getElementById('mp-files').files || []);

    if (amt <= 0){ document.getElementById('m-error').textContent = 'Enter amount'; return; }

    const toDataURL = f => new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f); });
    const attachments = [];
    for (const f of files){ attachments.push(await toDataURL(f)); }

    inv.payments = Array.isArray(inv.payments) ? inv.payments : [];
    inv.payments.push({ method, amount: Math.round(amt*100)/100, note, attachments });

    inv.paid    = Math.round(((inv.paid||0)+amt)*100)/100;
    inv.balance = Math.max(0, Math.round(((inv.total||0)-inv.paid)*100)/100);
    inv.status  = inv.balance <= 0 ? 'PAID' : 'PARTIAL';

    list[idx] = inv;
    write('invoices', list);

    m.classList.add('hidden');
    renderInvoices && renderInvoices();
    toast('Updated payment');
  };

  m.classList.remove('hidden');
}




function printInvoice(id){
  const inv = read('invoices',[]).find(x=>x.id===id); if(!inv) return;
  const rows = (inv.items||[]).map((it,idx)=>{
    return `<tr>
      <td>${idx+1}</td>
      <td>${it.name || ''} (${it.rowType || ''})</td>
      <td class="right">${it.qty || 0}</td>
      <td class="right">${money(it.price || 0)}</td>
      <td class="right">${money(it.cost || 0)}</td>
      <td class="right">${money(it.total || (Number(it.qty||0)*Number(it.price||0)))}</td>
      <td class="right">+ ${money(it.profit || (Number(it.qty||0)*(Number(it.price||0)-Number(it.baseline||it.cost||0))))}</td>
    </tr>`;
  }).join('');

  const payRows = ((inv.payments||[]).length
    ? inv.payments.map(p=> `<tr><td colspan="5" class="right">${METHOD_LABELS[p.method]||p.method}</td><td class="right" colspan="2">${money(p.amount||0)}</td></tr>`).join('')
    : '');

  const css = 'body{font-family:"Noto Sans Khmer", system-ui, Segoe UI, Arial, Roboto, sans-serif;padding:16px} table{width:100%;border-collapse:collapse} th,td{border:1px solid #ccc;padding:6px;text-align:left} .right{text-align:right}';

  const html = `<!doctype html>
  <html><head><meta charset="utf-8"><title>${inv.invNo||''}</title><style>${css}</style></head>
  <body>
    <h2>Invoice ${inv.invNo||''}</h2>
    <div><b>Date:</b> ${new Date(inv.datetime).toLocaleString()}</div>
    <div><b>Customer:</b> ${inv.customer||''} ‚Äî üìû ${inv.customerPhone||'-'} ‚Äî üìç ${inv.customerLocation||'-'}</div>
    <!-- Seller removed for print -->
    <table>
      <thead>
        <tr><th>#</th><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Cost</th><th class="right">Total</th><th class="right">Profit</th></tr>
      </thead>
      <tbody>${rows}</tbody>
      <tfoot>
        <tr><td colspan="6" class="right">Subtotal</td><td class="right">${money(inv.subtotal||0)}</td></tr>
        <tr><td colspan="6" class="right">Discount</td><td class="right">- ${money(inv.discount||0)}</td></tr>
        <tr><td colspan="6" class="right"><b>TOTAL</b></td><td class="right"><b>${money(inv.total||0)}</b></td></tr>
        
        <tr><td colspan="6" class="right">Paid</td><td class="right">${money(inv.paid||0)}</td></tr>
        <tr><td colspan="6" class="right">Balance</td><td class="right">${money(inv.balance||0)}</td></tr>
        
      </tfoot>
    </table>
    <script>window.onload=()=>{ try{ window.print(); }catch(e){} };<\/script>
  </body></html>`;

  let w = null; try{ w = window.open('','_blank','width=900,height=900'); }catch(e){}
  if (w && w.document){ w.document.write(html); w.document.close(); }
  else {
    const blob = new Blob([html], {type:'text/html'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = (inv.invNo||'invoice') + ".html";
    a.click();
  }
}


// Hook: open dashboard tab
(function(){
  const tabBtn = Array.from(document.querySelectorAll('.tab')).find(b=> b.dataset.view==='dashboard');
  if (tabBtn && !tabBtn._dashBound){
    tabBtn._dashBound = true;
    // also ensure country i18n unchanged; dashboard uses English labels intentionally simple
  }
})();

// === Export to PDF (via Print) ===
(function attachExportPdf() {
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  ready(function(){
    var btn = document.getElementById('btn-export-pdf');
    if(!btn) return;
    btn.addEventListener('click', function(){
      // Add a class to limit print area to the report view
      document.body.classList.add('print-report-only');
      setTimeout(function(){
        window.print();
        // Remove the class after print
        document.body.classList.remove('print-report-only');
      }, 50);
    });
  });
})();



function initDashboard(){
  try {
    // --- Low Stock table ---
    const prods = read('products',[]) || [];
    const low = (typeof LOW_STOCK_THRESHOLD!=='undefined') ? LOW_STOCK_THRESHOLD : 5;
    const lows = prods.filter(p=> (Number(p.qty||p.stock||0) <= low));
    const stBody = document.querySelector('#d-stock tbody');
    if (stBody){
      stBody.innerHTML = (
  lows.map(p=> `<tr><td>${p.name||'(No name)'}</td><td class="right">${Number(p.qty||p.stock||0)}</td></tr>`).join('')
) || '<tr><td colspan="2">No low stock</td></tr>';
}

  // --- Quick Money In (Cash/Bank) ---
  try {
    // Read existing sources
    const ledger = read('ledger',[]) || [];
    const invs = read('invoices',[]) || [];
    const pays = invs.flatMap(i=> (i.payments||[]));

    // Helper to sum by predicate
    const sum = arr => arr.reduce((s,x)=> s + Number(x||0), 0);

    // Normalize method/currency
    function mc(v){ return String(v||'').toUpperCase(); }

    // From invoice payments (if they have currency, use it; else default USD)
    const pay = {ABA:{KHR:0,USD:0}, ACLEDA:{KHR:0,USD:0}, CASH:{KHR:0,USD:0}};
    pays.forEach(p=>{
      const m = mc(p.method);
      const c = mc(p.currency||p.curr||'USD');
      if (pay[m] && (c==='KHR'||c==='USD')) pay[m][c] += Number(p.amount||0);
    });

    // From ledger: deposits add, withdrawals subtract
    const dep = {ABA:{KHR:0,USD:0}, ACLEDA:{KHR:0,USD:0}, CASH:{KHR:0,USD:0}};
    ledger.forEach(x=>{
      if (x && (x.type==='DEPOSIT' || x.type==='WITHDRAW')){
        const m = mc(x.method);
        const c = mc(x.currency||x.curr||'USD');
        const sign = x.type==='WITHDRAW' ? -1 : 1;
        if (dep[m] && (c==='KHR'||c==='USD')) dep[m][c] += sign * Number(x.amount||0);
      }
    });

    const bal = {ABA:{KHR:0,USD:0}, ACLEDA:{KHR:0,USD:0}, CASH:{KHR:0,USD:0}};
    (['ABA','ACLEDA','CASH']).forEach(a=> (['KHR','USD']).forEach(c=> { bal[a][c] = (pay[a][c] + dep[a][c]); }));
    // expose for KPI to mirror exactly what is shown
    window.__qmi_bal = bal;

    // Render 6 balances
    const balBox = byId('qmi-balances');
    if (balBox){
      balBox.innerHTML = `
        <div class="stat"><div class="k">ABA (·üõ)</div><div class="v">${bal.ABA.KHR.toFixed(2)}</div></div>
        <div class="stat"><div class="k">ABA ($)</div><div class="v">$ ${bal.ABA.USD.toFixed(2)}</div></div>
        <div class="stat"><div class="k">ACLEDA (·üõ)</div><div class="v">${bal.ACLEDA.KHR.toFixed(2)}</div></div>
        <div class="stat"><div class="k">ACLEDA ($)</div><div class="v">$ ${bal.ACLEDA.USD.toFixed(2)}</div></div>
        <div class="stat"><div class="k">CASH (·üõ)</div><div class="v">${bal.CASH.KHR.toFixed(2)}</div></div>
        <div class="stat"><div class="k">CASH ($)</div><div class="v">$ ${bal.CASH.USD.toFixed(2)}</div></div>
      `;
    }

    // Render ledger table (show account + currency)
    const tbody = byId('qmi-table');
    if (tbody){
      const rows = ledger.slice().reverse().slice(0,50).map(x=> `
        <tr>
          <td>${new Date(x.datetime||Date.now()).toLocaleString()}</td>
          <td>${x.type||''}</td>
          <td>${(x.method||'').toUpperCase()} ¬∑ ${(x.currency||'USD').toUpperCase()}</td>
          <td class="right">${x.type==='WITHDRAW' ? '- ' : ''}${(Number(x.amount||0)).toFixed(2)}</td>
          <td>${x.note||''}</td>
        </tr>`).join('');
      tbody.innerHTML = rows || '<tr><td colspan="5">No records</td></tr>';
    }

    // Wire Add button
    const btn = byId('qmi-add');
    if (btn){
      btn.onclick = ()=>{
        const txType = (byId('qmi-type')?.value || 'IN').toUpperCase();
        const from = (byId('qmi-dest')?.value || 'CASH').toUpperCase();
        const to = (byId('qmi-to')?.value || '').toUpperCase();
        const currency = (byId('qmi-curr')?.value || 'USD').toUpperCase();
        const amount = Number(byId('qmi-amount')?.value || 0);
        const noteRaw = (byId('qmi-note')?.value || '').trim();
        if (!amount || amount<=0){ alert('Enter amount'); return; }
        // If transfer destination is chosen, do a transfer (OUT from from, IN to to)
        const list = read('ledger',[]) || [];
        if (to && to!==from){
          const note = noteRaw ? (noteRaw + ' ‚Äî Transfer') : 'Transfer';
          list.push({id: uid(), type:'WITHDRAW', method: from, currency, amount, note, datetime: Date.now()});
          list.push({id: uid(), type:'DEPOSIT', method: to, currency, amount, note, datetime: Date.now()});
        } else {
          const note = noteRaw;
          list.push({id: uid(), type: (txType==='OUT' ? 'WITHDRAW' : 'DEPOSIT'), method: from, currency, amount, note, datetime: Date.now()});
        }
        write('ledger', list);
        byId('qmi-amount').value = ''; byId('qmi-note').value = '';
        initDashboard();
      };
    }
    } catch(e){ console.warn('Quick Money widget failed', e); }
    const kpi = document.getElementById('dash-kpi');
    if (kpi){
      const invs = read('invoices',[]) || [];
      const totalSales = invs.reduce((s,i)=> s + (Number(i.total)||0), 0);
      const totalProfit = invs.reduce((s,i)=> s + (Number(i.profit)||0), 0);
      const count = invs.length;
      // Compute Input Totals using the exact balances already rendered (if available)
      const qmiBal = window.__qmi_bal;
      let inputUSD, inputKHR, destTotals;
      if (qmiBal){
        destTotals = qmiBal;
        inputUSD = Number((qmiBal.ABA.USD||0) + (qmiBal.ACLEDA.USD||0) + (qmiBal.CASH.USD||0));
        inputKHR = Number((qmiBal.ABA.KHR||0) + (qmiBal.ACLEDA.KHR||0) + (qmiBal.CASH.KHR||0));
      } else {
        // Fallback: recompute from ledger
        const ledgerAll = read('ledger',[]) || [];
        destTotals = {ABA:{KHR:0,USD:0}, ACLEDA:{KHR:0,USD:0}, CASH:{KHR:0,USD:0}};
        ledgerAll.forEach(x=>{
          if (x && (x.type==='DEPOSIT' || x.type==='WITHDRAW')){
            const method = String(x.method||'CASH').toUpperCase();
            const cur = String(x.currency||'USD').toUpperCase();
            const amt = Number(x.amount||0) || 0;
            const sign = x.type==='WITHDRAW' ? -1 : 1;
            if (destTotals[method] && cur in destTotals[method]) destTotals[method][cur] += sign * amt;
          }
        });
        inputUSD = Number((destTotals.ABA.USD||0) + (destTotals.ACLEDA.USD||0) + (destTotals.CASH.USD||0));
        inputKHR = Number((destTotals.ABA.KHR||0) + (destTotals.ACLEDA.KHR||0) + (destTotals.CASH.KHR||0));
      }
      // removed detailed breakdown under Input Total per request
      const inputUSDDisp = `$ ${inputUSD.toFixed(2)}`;
      const inputKHRDisp = `·üõ ${Number(inputKHR||0).toFixed(2)}`;
      kpi.innerHTML = [
        `<div class="stat"><div class="stat-title k">Total Sales</div><div class="stat-val v">$ ${totalSales.toFixed(2)}</div></div>`,
        `<div class="stat"><div class="stat-title k">Total Profit</div><div class="stat-val v">$ ${totalProfit.toFixed(2)}</div></div>`,
        `<div class="stat"><div class="stat-title k">Input Total</div><div class="stat-val v">${inputUSDDisp} ¬∑ ${inputKHRDisp}</div></div>`,
        `<div class="stat"><div class="stat-title k">Invoices</div><div class="stat-val v">${count}</div></div>`
      ].join('');
    }

    // --- Recent Invoices (simple) ---
    const invTable = document.querySelector('#d-invoices tbody');
    if (invTable){
      const invs = (read('invoices',[]) || []).slice().sort((a,b)=> new Date(b.datetime||b.date||0) - new Date(a.datetime||a.date||0)).slice(0,50);
      invTable.innerHTML = invs.map((i,idx)=>{
        const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
        const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
        return `<tr>
          <td>${idx+1}</td>
          <td>${new Date(i.datetime||i.date).toLocaleString()}</td>
          <td>${i.invNo||''}</td>
          <td>${i.customer||''}</td>
          <td>${i.seller||''}</td>
          <td>${i.branch||''}</td>
          <td class="right">$ ${(i.total||0).toFixed(2)}</td>
          <td class="right">$ ${(i.profit||0).toFixed(2)}</td>
          <td class="right">${status}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="9">No invoices</td></tr>';
      const cnt = document.getElementById('d-inv-count'); if (cnt) cnt.textContent = invs.length + ' found';
      // also set sums for initial dashboard paint
      const sumsEl = document.getElementById('d-inv-sums');
      if (sumsEl){
        const totals = invs.reduce((acc,i)=>{ acc.sales += Number(i.total||0); acc.profit += Number(i.profit||0); return acc; }, {sales:0, profit:0});
        const sales = '$ ' + (Math.round(totals.sales*100)/100).toFixed(2);
        const prof  = '$ ' + (Math.round(totals.profit*100)/100).toFixed(2);
        sumsEl.innerHTML = `<b>Total Sales:</b> ${sales} &nbsp; ¬∑ &nbsp; <b>Total Profit:</b> ${prof}`;
      }
    }

    // --- Top Products ---
    const topBody = document.querySelector('#d-top tbody');
    if (topBody){
      const invs = read('invoices',[]) || [];
      const agg = {};
      invs.forEach(inv=> (inv.items||[]).forEach(it=>{
        const k = it.name || it.productId || '(No name)';
        if (!agg[k]) agg[k] = {qty:0, sales:0, profit:0};
        agg[k].qty += Number(it.qty||0);
        agg[k].sales += Number(it.amount||it.total|| (Number(it.qty||0)*Number(it.price||0)) || 0);
        agg[k].profit += Number(it.profit|| (Number(it.qty||0)*(Number(it.price||0)-Number(it.baseline||0))) || 0);
      }));
      const rows = Object.entries(agg).sort((a,b)=> b[1].sales - a[1].sales).slice(0,20)
        .map(([name,v])=> `<tr><td>${name}</td><td class="right">${v.qty}</td><td class="right">$ ${v.sales.toFixed(2)}</td><td class="right">$ ${v.profit.toFixed(2)}</td></tr>`)
        .join('');
      topBody.innerHTML = rows || '<tr><td colspan="4">No data</td></tr>';
      const tc = document.getElementById('d-top-count'); if (tc) tc.textContent = Object.keys(agg).length;
    }
  } catch(e){ console.error('initDashboard failed', e); }
}

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

  <section id="view-report-all" class="view">
    <div class="card">
      <h2>üìä <span data-i18n="report_all">Reports (All-in-One)</span></h2>
      <div class="grid three gap">
        <div>
          <label>Filter Mode</label>
          <select id="aof-filter-mode" class="input">
            <option value="range">Date Range</option>
            <option value="month">Month</option>
            <option value="year">Year</option>
          </select>
        </div>
        <div>
          <label>Date From ‚Üí To / Month / Year</label>
          <div class="row gap">
            <input id="aof-date-from" type="date" class="input">
            <input id="aof-date-to" type="date" class="input">
            <input id="aof-month" type="month" class="input" style="display:none">
            <input id="aof-year" type="number" min="2000" max="2100" class="input" placeholder="2025" style="display:none">
          </div>
        </div>
        <div>
          <label>Style</label>
          <select id="aof-style" class="input">
            <option value="simple">A) Simple Table</option>
            <option value="summary">B) Table + Summary</option>
            <option value="group">C) Grouped (Customer/Seller/Product)</option>
          </select>
        </div>
      </div>

      <div class="row gap mt">
        <button class="btn" id="aof-generate">Generate</button>
        <button class="btn ghost" id="aof-export">Export CSV</button>
        <button class="btn ghost" id="aof-print">Print / PDF</button>
      </div>

      <div class="kpi grid four mt" id="aof-kpi"></div>
      <div id="aof-charts" class="grid two gap mt"></div>

      <div class="tabs mt" id="aof-tabs">
        <button class="tab active" data-tab="sales">Sales</button>
        <button class="tab" data-tab="purchase">Purchase</button>
        <button class="tab" data-tab="expense">Expense</button>
        <button class="tab" data-tab="stock">Stock</button>
      </div>

      <div id="aof-tables" class="mt">
        <div class="tabpane active" data-tab="sales"><table class="table" id="aof-sales"></table></div>
        <div class="tabpane" data-tab="purchase"><table class="table" id="aof-purchase"></table></div>
        <div class="tabpane" data-tab="expense"><table class="table" id="aof-expense"></table></div>
        <div class="tabpane" data-tab="stock"><table class="table" id="aof-stock"></table></div>
      </div>
    </div>
  </section>


<!-- QMI + Mark Paid integration patch -->
<script>
function qmiMethodToDestCurr(method){
  const parts = method.split('_'); // e.g., ['BANK','ABA','USD']
  if (parts[0]==='BANK') return { dest: parts[1] || 'ABA', currency: (parts[2]||'USD').toUpperCase() };
  return { dest: (parts[0]||'CASH').toUpperCase(), currency: (parts[1]||'USD').toUpperCase() };
}
function qmiMoney(n){ return (Math.round((Number(n)||0)*100)/100).toFixed(2); }
function loadQMI(){
  const list = read('qmi',[]) || [];
  const tbody = document.getElementById('qmi-table');
  if (tbody){
    tbody.innerHTML = list.map(r=>`
      <tr>
        <td>${new Date(r.datetime||Date.now()).toLocaleString()}</td>
        <td>${r.currency}</td>
        <td>${r.dest}</td>
        <td class="right">${qmiMoney(r.amount)}</td>
        <td>${r.note||''}</td>
      </tr>
    `).join('') || '<tr><td colspan="5">No data</td></tr>';
  }
  const bal = { CASH_KHR:0, CASH_USD:0, ABA_KHR:0, ABA_USD:0, ACLEDA_KHR:0, ACLEDA_USD:0 };
  list.forEach(r=>{
    const key = ((r.dest||'CASH').toUpperCase()) + '_' + (r.currency||'USD').toUpperCase();
    if (bal[key]!==undefined) bal[key] += Number(r.amount||0);
  });
  const balances = document.getElementById('qmi-balances');
  if (balances){
    balances.innerHTML = `
      <div>ABA (·üõ) ${qmiMoney(bal.ABA_KHR)}</div>
      <div>ABA ($) ${qmiMoney(bal.ABA_USD)}</div>
      <div>ACLEDA (·üõ) ${qmiMoney(bal.ACLEDA_KHR)}</div>
      <div>ACLEDA ($) ${qmiMoney(bal.ACLEDA_USD)}</div>
      <div>CASH (·üõ) ${qmiMoney(bal.CASH_KHR)}</div>
      <div>CASH ($) ${qmiMoney(bal.CASH_USD)}</div>
    `;
  }
}
(function bindQMI(){
  const btn = document.getElementById('qmi-add');
  if(!btn) return;
  btn.onclick = ()=>{
    const dest = (document.getElementById('qmi-dest')?.value||'CASH').toUpperCase();
    const currency = (document.getElementById('qmi-curr')?.value||'USD').toUpperCase();
    const amount = Number(document.getElementById('qmi-amount')?.value||0);
    const note = document.getElementById('qmi-note')?.value||'';
    if(amount<=0){ toast('·ûÖ·üÜ·ûì·ûΩ·ûì·ûè·üí·ûö·ûº·ûú > 0'); return; }
    const list = read('qmi',[]) || [];
    list.unshift({ id: uid(), dest, currency, amount, note, datetime: Date.now() });
    write('qmi', list);
    toast('·ûî·û∂·ûì·ûî·ûì·üí·ûê·üÇ·ûò·ûö·ûΩ·ûÖ!'); loadQMI();
    const amtEl = document.getElementById('qmi-amount'); if (amtEl) amtEl.value='';
    const noteEl = document.getElementById('qmi-note'); if (noteEl) noteEl.value='';
  };
})();
if (typeof initDashboard !== 'function'){ window.initDashboard = function(){ loadQMI(); }; }
else { const _initDashboard = initDashboard; window.initDashboard = function(){ _initDashboard && _initDashboard(); loadQMI(); }; }
loadQMI();
const _openMarkPaidModal = typeof openMarkPaidModal==='function' ? openMarkPaidModal : null;
window.openMarkPaidModal = function(invId){
  if(!_openMarkPaidModal){ return; }
  _openMarkPaidModal(invId);
  const saveBtn = document.getElementById('m-save');
  if(!saveBtn || saveBtn._qmi_patched) return;
  saveBtn._qmi_patched = true;
  const origOnclick = saveBtn.onclick;
  saveBtn.onclick = function(){
    const method = (document.getElementById('mp-method')?.value||'CASH_USD').toUpperCase();
    const amount = Number(document.getElementById('mp-amount')?.value||0);
    origOnclick && origOnclick();
    if (amount>0){
      const map = qmiMethodToDestCurr(method);
      const list = read('qmi',[]) || [];
      const inv = (read('invoices',[])||[]).find(i=>i.id===invId);
      list.unshift({ id: uid(), dest: map.dest, currency: map.currency, amount, note: 'Mark Paid '+(inv?.invNo||''), datetime: Date.now() });
      write('qmi', list);
      loadQMI(); if (typeof initDashboard==='function') initDashboard();
    }
      // Auto-refresh after marking as paid
      setTimeout(function(){ location.reload(); }, 600);
  };
};

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- QMI v2: IN/OUT/TRANSFER + CSV Export -->
<script>
(function(){
  // Inject Type selector and Transfer fields into Quick Money UI (non-destructive)
  const card = document.getElementById('quick-money');
  if (card && !document.getElementById('qmi-type')){
    const row = card.querySelector('.row.gap');
    if (row){
      // Type
      const typeWrap = document.createElement('div');
      typeWrap.innerHTML = '<label class="small">Type</label><select id="qmi-type" class="input"><option value="IN">Money-In</option><option value="OUT">Money-Out</option><option value="TRF">Transfer</option></select>';
      row.insertBefore(typeWrap, row.firstChild);

      // From / To (for transfer)
      const fromWrap = document.createElement('div');
      fromWrap.style.display = 'none';
      fromWrap.innerHTML = '<label class="small">From</label><select id="qmi-from" class="input"><option value="CASH">Cash</option><option value="ABA">ABA</option><option value="ACLEDA">ACLEDA</option></select>';
      row.insertBefore(fromWrap, row.children[1]);

      const toWrap = document.createElement('div');
      toWrap.style.display = 'none';
      toWrap.innerHTML = '<label class="small">To</label><select id="qmi-to" class="input"><option value="ABA">ABA</option><option value="ACLEDA">ACLEDA</option><option value="CASH">Cash</option></select>';
      row.insertBefore(toWrap, row.children[2]);

      // Export button
      const exportBtn = document.createElement('button');
      exportBtn.id = 'qmi-export';
      exportBtn.className = 'btn ghost';
      exportBtn.textContent = 'Export CSV';
      exportBtn.style.alignSelf = 'end';
      row.parentElement.insertBefore(exportBtn, row.nextSibling);

      // Toggle fields
      const typeSel = typeWrap.querySelector('#qmi-type');
      const currSel = document.getElementById('qmi-curr');
      const destWrap = row.children[ fromWrap ? 2 : 1 ]; // original Destination wrapper shifts when we insert
      function updateMode(){
        const t = typeSel.value;
        if (t==='IN'){
          if (fromWrap) fromWrap.style.display = 'none';
          if (toWrap) toWrap.style.display = 'none';
          if (destWrap) destWrap.style.display = '';
          if (currSel) currSel.disabled = false;
        } else if (t==='OUT'){
          if (fromWrap) fromWrap.style.display = 'none';
          if (toWrap) toWrap.style.display = 'none';
          if (destWrap) destWrap.style.display = '';
          if (currSel) currSel.disabled = false;
        } else { // TRF
          if (fromWrap) fromWrap.style.display = '';
          if (toWrap) toWrap.style.display = '';
          if (destWrap) destWrap.style.display = 'none';
          if (currSel) currSel.disabled = false;
        }
      }
      typeSel.onchange = updateMode;
      updateMode();

      // Export handler
      exportBtn.onclick = function(){
        const list = read('qmi',[])||[];
        const headers = ['datetime','type','from','to','dest','currency','amount','note'];
        const lines = [headers.join(',')];
        list.forEach(r=>{
          const row = [
            new Date(r.datetime||Date.now()).toISOString(),
            (r.type||'IN'),
            (r.src||''),
            (r.type==='TRF'? (r.dest||'') : ''),
            (r.dest||''),
            (r.currency||'USD'),
            Number(r.amount||0).toFixed(2),
            (r.note||'').replace(/"/g,'""')
          ];
          // CSV escaping
          const escaped = row.map(v => /[",\n]/.test(String(v)) ? ('"'+String(v)+'"') : String(v));
          
          lines.push(escaped.join(','));
        });
      };
    }
  }

  // Patch save/append logic to support IN/OUT/TRF (extends previous qmi-add and Mark Paid integration)
  function qmiAppend(entry){
    // entry: {type:'IN'|'OUT'|'TRF', src?, dest, currency, amount, note, datetime}
    const list = read('qmi',[])||[];
    list.unshift(entry);
    write('qmi', list);
  }

  // Override Add button (if exists)
  const addBtn = document.getElementById('qmi-add');
  if (addBtn && !addBtn._v2){
    addBtn._v2 = true;
    addBtn.onclick = function(){
      const t = (document.getElementById('qmi-type')?.value||'IN');
      const dest = (document.getElementById('qmi-dest')?.value||'CASH').toUpperCase();
      const from = (document.getElementById('qmi-from')?.value||'CASH').toUpperCase();
      const to = (document.getElementById('qmi-to')?.value||'ABA').toUpperCase();
      const currency = (document.getElementById('qmi-curr')?.value||'USD').toUpperCase();
      const amount = Number(document.getElementById('qmi-amount')?.value||0);
      const note = document.getElementById('qmi-note')?.value||'';
      if (amount<=0){ toast('·ûÖ·üÜ·ûì·ûΩ·ûì·ûè·üí·ûö·ûº·ûú > 0'); return; }

      if (t==='TRF'){
        if (from===to){ toast('Transfer: From/To ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂'); return; }
        qmiAppend({ id: uid(), type:'TRF', src:from, dest:to, currency, amount, note, datetime: Date.now() });
      } else if (t==='OUT'){
        qmiAppend({ id: uid(), type:'OUT', dest:dest, currency, amount, note, datetime: Date.now() });
      } else {
        qmiAppend({ id: uid(), type:'IN', dest:dest, currency, amount, note, datetime: Date.now() });
      }
      toast('Recorded!'); loadQMIv2();
      const a = document.getElementById('qmi-amount'); if (a) a.value='';
      const n = document.getElementById('qmi-note'); if (n) n.value='';
    };
  }

  // Extend loadQMI to support OUT/TRF and CSV export
  window.loadQMIv2 = function(){
    const list = read('qmi',[])||[];
    // table
    const tbody = document.getElementById('qmi-table');
    if (tbody){
      tbody.innerHTML = list.map(r=>`
        <tr>
          <td>${new Date(r.datetime||Date.now()).toLocaleString()}</td>
          <td>${r.type||'IN'}</td>
          <td>${r.type==='TRF' ? (r.src||'') : ''}</td>
          <td>${r.dest||''}</td>
          <td class="right">${(r.currency||'USD')} ${ (Math.round(Number(r.amount||0)*100)/100).toFixed(2)}</td>
          <td>${r.note||''}</td>
        </tr>`).join('') || '<tr><td colspan="6">No data</td></tr>';
    }
    // balances
    const bal = { CASH_KHR:0, CASH_USD:0, ABA_KHR:0, ABA_USD:0, ACLEDA_KHR:0, ACLEDA_USD:0 };
    function key(d,c){ return d + '_' + c; }
    list.forEach(r=>{
      const t = r.type||'IN';
      if (t==='IN'){
        const k = key((r.dest||'CASH').toUpperCase(), (r.currency||'USD').toUpperCase());
        if (bal[k]!==undefined) bal[k] += Number(r.amount||0);
      } else if (t==='OUT'){
        const k = key((r.dest||'CASH').toUpperCase(), (r.currency||'USD').toUpperCase());
        if (bal[k]!==undefined) bal[k] -= Number(r.amount||0);
      } else if (t==='TRF'){
        const kFrom = key((r.src||'CASH').toUpperCase(), (r.currency||'USD').toUpperCase());
        const kTo   = key((r.dest||'ABA').toUpperCase(), (r.currency||'USD').toUpperCase());
        if (bal[kFrom]!==undefined) bal[kFrom] -= Number(r.amount||0);
        if (bal[kTo]!==undefined)   bal[kTo] += Number(r.amount||0);
      }
    });
    const balances = document.getElementById('qmi-balances');
    if (balances){
      function money(n){ return (Math.round(Number(n)*100)/100).toFixed(2); }
      balances.innerHTML = `
        <div>ABA (·üõ) ${money(bal.ABA_KHR)}</div>
        <div>ABA ($) ${money(bal.ABA_USD)}</div>
        <div>ACLEDA (·üõ) ${money(bal.ACLEDA_KHR)}</div>
        <div>ACLEDA ($) ${money(bal.ACLEDA_USD)}</div>
        <div>CASH (·üõ) ${money(bal.CASH_KHR)}</div>
        <div>CASH ($) ${money(bal.CASH_USD)}</div>
      `;
    }
  };

  // CSV exporter (rebuilt avoiding earlier inline creation due to CSV escaping)
  window.exportQMIasCSV = function(){
    const list = read('qmi',[])||[];
    const headers = ['datetime','type','from','to','dest','currency','amount','note'];
    const rows = [headers];
    list.forEach(r=>{
      
    });
  };

  // Provide button handler if created
  const exBtn = document.getElementById('qmi-export');
  if (exBtn && !exBtn._wired){
    exBtn._wired = true;
    exBtn.onclick = function(){
      const list = read('qmi',[])||[];
      const headers = ['datetime','type','from','to','dest','currency','amount','note'];
      const lines = [headers.join(',')];
      list.forEach(r=>{
        const row = [
          new Date(r.datetime||Date.now()).toISOString(),
          (r.type||'IN'),
          (r.src||''),
          (r.type==='TRF'? (r.dest||'') : ''),
          (r.dest||''),
          (r.currency||'USD'),
          (Number(r.amount||0)).toFixed(2),
          (r.note||'').replace(/"/g,'""')
        ];
        const escaped = row.map(v => /[",\n]/.test(String(v)) ? ('"'+String(v)+'"') : String(v));
        
        lines.push(escaped.join(','));
      });
    };
  }

  // Ensure v2 loader runs after v1
  if (typeof loadQMIv2==='function') loadQMIv2();
  else if (typeof loadQMI==='function'){ loadQMI(); setTimeout(()=>{ if (typeof loadQMIv2==='function') loadQMIv2(); }, 50); }

  // Patch Mark Paid integration to store type IN (already added in earlier patch) ‚Äî balances now computed with v2
  // No code changes needed here; previous push remains valid as type defaults to IN.
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<script>
(function(){
  const exBtn = document.getElementById('qmi-export');
  if (exBtn && !exBtn._dlwired){
    exBtn._dlwired = true;
    exBtn.onclick = function(){
      const list = read('qmi',[])||[];
      const headers = ['datetime','type','from','to','dest','currency','amount','note'];
      const lines = [headers.join(',')];
      list.forEach(r=>{
        const row = [
          new Date(r.datetime||Date.now()).toISOString(),
          (r.type||'IN'),
          (r.src||''),
          (r.type==='TRF'? (r.dest||'') : ''),
          (r.dest||''),
          (r.currency||'USD'),
          (Number(r.amount||0)).toFixed(2),
          (r.note||'').replace(/"/g,'""')
        ];
        const escaped = row.map(v => /[",\n]/.test(String(v)) ? ('"'+String(v)+'"') : String(v));
        lines.push(escaped.join(','));
      });
      const csv = lines.join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'qmi_ledger.csv';
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    };
  }
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Recent Invoices: Qty-only filter patch -->
<script>
(function(){
  // Inject "Qty ‚â•" control next to existing Filter buttons
  function injectQtyFilterUI(){
    const applyBtn = document.getElementById('d-apply');
    const clearBtn = document.getElementById('d-clear');
    if (!applyBtn || document.getElementById('d-min-qty')) return;
    const container = applyBtn.parentElement;
    const wrap = document.createElement('div');
    wrap.className = 'row gap';
    wrap.style.marginTop = '8px';
    wrap.innerHTML = `
      <label class="small">Qty ‚â•</label>
      <input id="d-min-qty" class="input sm" type="number" step="1" min="0" value="0" />
      <button id="d-apply-qty" class="btn ghost">Apply Qty</button>
    `;
    container.parentElement.appendChild(wrap);
  }

  function money(n){ return '$ ' + (Math.round((Number(n)||0)*100)/100).toFixed(2); }

  function renderRecentInvoicesQtyOnly(){
    const minQty = Math.max(0, Math.floor(Number(document.getElementById('d-min-qty')?.value||0)));
    const invs = (read && read('invoices',[])) || [];
    // Compute total Qty per invoice
    const show = invs.filter(inv => {
      const items = Array.isArray(inv.items) ? inv.items : [];
      const q = items.reduce((s,it)=> s + (Number(it.qty)||0), 0);
      return q >= minQty;
    });

    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = document.getElementById('d-inv-count');
    if (!tbody) return;

    tbody.innerHTML = show.map((i,idx)=>{
      const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
      const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
      return `<tr>
        <td>${idx+1}</td>
        <td>${new Date(i.datetime || (i.date? (i.date+'T00:00:00'): Date.now())).toLocaleString()}</td>
        <td>${i.invNo||''}</td>
        <td>${i.customer||''}</td>
        <td>${i.seller||''}</td>
        <td>${i.branch||''}</td>
        <td class="right">${money(i.total||0)}</td>
        <td class="right">${money(i.profit||0)}</td>
        <td class="right">${status}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="9">No data</td></tr>';

    if (countEl) countEl.textContent = `${show.length} found`;
  }

  function wireQtyFilter(){
    const btn = document.getElementById('d-apply-qty');
    if (!btn || btn._wired_qty) return;
    btn._wired_qty = true;
    btn.onclick = renderRecentInvoicesQtyOnly;

    const input = document.getElementById('d-min-qty');
    if (input && !input._wired_qty){
      input._wired_qty = true;
      input.onkeydown = (e)=>{ if (e.key==='Enter') renderRecentInvoicesQtyOnly(); };
    }
  }

  function initQtyFilter(){
    injectQtyFilterUI();
    wireQtyFilter();
  }

  // Run now and also after potential dashboard init
  initQtyFilter();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      initQtyFilter();
    };
  }
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Recent Invoices: replace columns with Total Qty (no Total $) -->
<script>
(function(){
  function setRecentHeaderToQty(){
    const thead = document.querySelector('#d-invoices thead tr');
    if (!thead) return;
    // Only replace once
    if (thead._qtyHeader) return;
    thead._qtyHeader = true;
    thead.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Total Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }

  function computeQty(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.reduce((s,it)=> s + (Number(it.qty)||0), 0);
  }
  function money(n){ return '$ ' + (Math.round((Number(n)||0)*100)/100).toFixed(2); }

  // Override our Qty-only renderer to match new header
  function renderRecentInvoicesQtyOnly(){
    setRecentHeaderToQty();
    const minQty = Math.max(0, Math.floor(Number(document.getElementById('d-min-qty')?.value||0)));
    const invs = (read && read('invoices',[])) || [];
    const show = invs.filter(inv => computeQty(inv) >= minQty);
    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = document.getElementById('d-inv-count');
    if (!tbody) return;

    tbody.innerHTML = show.map((i,idx)=>{
      const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
      const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
      const q = computeQty(i);
      return `<tr>
        <td>${idx+1}</td>
        <td>${new Date(i.datetime || (i.date? (i.date+'T00:00:00'): Date.now())).toLocaleString()}</td>
        <td>${i.invNo||''}</td>
        <td>${i.customer||''}</td>
        <td>${i.seller||''}</td>
        <td>${i.branch||''}</td>
        <td class="right">${q}</td>
        <td class="right">${money(i.profit||0)}</td>
        <td class="right">${status}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="9">No data</td></tr>';

    if (countEl) countEl.textContent = `${show.length} found`;
  }

  // Wire our button if present (from v3 patch)
  function wireQtyApply(){
    const btn = document.getElementById('d-apply-qty');
    if (!btn || btn._wired_qty_header) return;
    btn._wired_qty_header = true;
    btn.onclick = renderRecentInvoicesQtyOnly;
  }

  // Also, when Dashboard init runs, make sure header is set once
  function boostDashboard(){
    setRecentHeaderToQty();
    wireQtyApply();
  }

  boostDashboard();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      boostDashboard();
    };
  }
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Recent Invoices: Qty = number of items (count), not sum -->
<script>
(function(){
  function setRecentHeaderToQtyCount(){
    const thead = document.querySelector('#d-invoices thead tr');
    if (!thead) return;
    if (thead._qtyCountHeader) return;
    thead._qtyCountHeader = true;
    thead.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }

  function qtyCount(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.length; // count of line items
  }
  function money(n){ return '$ ' + (Math.round((Number(n)||0)*100)/100).toFixed(2); }

  // Override Qty-only renderer (from v3/v4) to use count
  function renderRecentInvoicesQtyOnly_COUNT(){
    setRecentHeaderToQtyCount();
    const minQty = Math.max(0, Math.floor(Number(document.getElementById('d-min-qty')?.value||0)));
    const invs = (read && read('invoices',[])) || [];
    const show = invs.filter(inv => qtyCount(inv) >= minQty);
    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = document.getElementById('d-inv-count');
    if (!tbody) return;

    tbody.innerHTML = show.map((i,idx)=>{
      const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
      const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
      const q = qtyCount(i);
      return `<tr>
        <td>${idx+1}</td>
        <td>${new Date(i.datetime || (i.date? (i.date+'T00:00:00'): Date.now())).toLocaleString()}</td>
        <td>${i.invNo||''}</td>
        <td>${i.customer||''}</td>
        <td>${i.seller||''}</td>
        <td>${i.branch||''}</td>
        <td class="right">${q}</td>
        <td class="right">${money(i.profit||0)}</td>
        <td class="right">${status}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="9">No data</td></tr>';

    if (countEl) countEl.textContent = `${show.length} found`;
  }

  // Wire button to new renderer (if exists)
  function wireQtyApplyCount(){
    const btn = document.getElementById('d-apply-qty');
    if (!btn || btn._wired_qty_count) return;
    btn._wired_qty_count = true;
    btn.onclick = renderRecentInvoicesQtyOnly_COUNT;
  }

  // Also ensure header is correct on dashboard init
  function boostDashboardQtyCount(){
    setRecentHeaderToQtyCount();
    wireQtyApplyCount();
  }

  boostDashboardQtyCount();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      boostDashboardQtyCount();
    };
  }
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Recent Invoices: force Qty (count) not money in column -->
<script>
(function(){
  function computeQtyCount(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.length;
  }
  function mapInvByNo(){
    const m = new Map();
    const invs = (read && read('invoices',[])) || [];
    invs.forEach(i => { if (i && (i.invNo||'').trim()) m.set(String(i.invNo).trim(), i); });
    return m;
  }
  function setHeaderToQty(){
    const thead = document.querySelector('#d-invoices thead tr');
    if (!thead) return;
    // Build header with Qty (count)
    thead.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }
  function fixQtyCells(){
    const table = document.getElementById('d-invoices');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    const invMap = mapInvByNo();
    [...tbody.rows].forEach(row => {
      // Columns: 0#,1Date,2No,3Customer,4Seller,5Branch,6Qty,7Profit,8Status
      const noCell = row.cells && row.cells[2];
      const qtyCell = row.cells && row.cells[6];
      if (!noCell || !qtyCell) return;
      const invNo = (noCell.textContent || '').trim();
      const inv = invMap.get(invNo);
      if (!inv) return;
      const q = computeQtyCount(inv);
      qtyCell.textContent = String(q); // ensure plain number, no "$"
      qtyCell.classList.add('right');
    });
  }
  function wireRefreshers(){
    const ids = ['d-apply', 'd-clear', 'inv-status', 'inv-search'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el && !el._fixqty){
        el._fixqty = true;
        const ev = (id==='inv-search') ? 'input' : 'click';
        el.addEventListener(ev, () => setTimeout(fixQtyCells, 30));
      }
    });
  }
  function boost(){
    setHeaderToQty();
    fixQtyCells();
    wireRefreshers();
  }
  boost();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      setTimeout(boost, 50);
    };
  }
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Invoices table: add Qty count column (·ûÖ·üÜ·ûì·ûΩ·ûì) and set header order -->
<script>
(function(){
  function qtyCount(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.length;
  }

  // Replace thead headers order (once)
  function setInvoicesHeader(){
    const thead = document.querySelector('#inv-table thead tr');
    if (!thead) return;
    if (thead._qtyHeaderDone) return;
    thead._qtyHeaderDone = true;
    thead.innerHTML = `
      <th>#</th>
      <th>·ûê·üí·ûÑ·üÉ·ûÅ·üÇ</th>
      <th>No.</th>
      <th>·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã</th>
      <th>·ûü·û∂·ûÅ·û∂</th>
      <th class="right">·ûÖ·üÜ·ûì·ûΩ·ûì</th>
      <th class="right">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th>
      <th class="right">Total</th>
      <th class="right">·ûî·û∂·ûì·ûî·ûÑ·üã</th>
      <th class="right">·ûì·üÖ·ûü·ûõ·üã</th>
      <th>Action</th>
    `;
  }

  // Monkey-patch renderInvoices to include Qty column
  if (typeof renderInvoices === 'function' && !renderInvoices._qty_patched){
    const _renderInvoices = renderInvoices;
    window.renderInvoices = function(){
      // Call original to ensure filters/sorts are set up, then overwrite tbody safely
      try { _renderInvoices(); } catch(e){}
      setInvoicesHeader();

      // Re-run our own rendering to include qty
      const invsRaw = read('invoices',[]) || [];
      // Normalize datetime for sort consistency
      const invs = invsRaw.map(i => (i && i.datetime ? i : {...i, datetime: (i.date? new Date(i.date+'T00:00:00').toISOString(): new Date().toISOString()) }));

      // Respect existing controls
      const statusSel = document.getElementById('inv-status');
      const q = (document.getElementById('inv-search')?.value || '').toLowerCase();
      let show = invs.slice();

      // Apply INV_FILTER if available
      if (window.INV_FILTER && window.INV_FILTER !== 'ALL'){
        show = show.filter(i => (i.invType||'SALE') === window.INV_FILTER);
      }
      // Status filter
      const statusVal = statusSel ? statusSel.value : 'ALL';
      if (statusVal !== 'ALL'){
        show = show.filter(i => (i.status || ((i.balance||0)>0?'UNPAID':'PAID')) === statusVal);
      }
      // Keyword filter
      if (q){
        show = show.filter(i => {
          const hay = ( (i.invNo||'')+' '+(i.customer||'')+' '+(i.customer_phone||'')+' '+(i.seller||'')+' '+(i.branch||'')+' '+(i.notes||'') ).toLowerCase();
          return hay.includes(q);
        });
      }
      // Sort
      const S = window.INV_SORT || {by:'date', dir:'desc'};
      show.sort((a,b)=>{
        const dir = (S.dir==='asc') ? 1 : -1;
        switch (S.by){
          case 'total': return dir*((a.total||0)-(b.total||0));
          case 'status': return dir*((a.status||'').localeCompare(b.status||''));
          default: return dir*(new Date(a.datetime)-new Date(b.datetime));
        }
      });

      const tbody = document.querySelector('#inv-table tbody');
      if (!tbody) return;

      tbody.innerHTML = show.map((i,idx)=>{
        const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
        const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
        const qCount = qtyCount(i);
        return `<tr>
          <td>${idx+1}</td>
          <td>${new Date(i.datetime).toLocaleString()}</td>
          <td>${i.invNo||''}</td>
          <td>${i.seller||''}</td>
          <td>${i.branch||''}</td>
          <td class="right">${qCount}</td>
          <td class="right">${status}</td>
          <td class="right">$ ${(i.total||0).toFixed(2)}</td>
          <td class="right">$ ${(i.paid||0).toFixed(2)}</td>
          <td class="right">$ ${bal.toFixed(2)}</td>
          <td>
            <button class="btn ghost" data-print="${i.id}">Print</button>
            <button class="btn ghost" data-paid="${i.id}">Mark Paid</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="11">No data</td></tr>';

      // Re-bind actions
      tbody.querySelectorAll('[data-print]').forEach(b=> b.onclick=()=> printInvoice(b.dataset.print));
      tbody.querySelectorAll('[data-view]').forEach(b=> b.onclick=()=> viewInvoice(b.dataset.view));
  tbody.querySelectorAll('[data-paid]').forEach(b=> b.onclick=()=> openMarkPaidModal(b.dataset.paid));
    };
    renderInvoices._qty_patched = true;
  }

  // Ensure header on tab switch
  document.querySelectorAll('.tab[data-view="invoices"]').forEach(btn=>{
    if (btn._qty_hdr_wired) return;
    btn._qty_hdr_wired = true;
    btn.addEventListener('click', ()=> setTimeout(setInvoicesHeader, 30));
  });

  // If already on invoices view, apply now
  setTimeout(setInvoicesHeader, 50);
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Qty fix: use SUM of item.qty per invoice -->
<script>
(function(){
  // Sum quantities inside invoice.items
  function qtySum(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.reduce((s,it)=> s + (Number(it.qty)||0), 0);
  }

  // --- Recent Invoices (Dashboard) ---
  function ensureRecentHeaderQty(){
    const thead = document.querySelector('#d-invoices thead tr');
    if (!thead) return;
    thead.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }
  function renderRecentInvoicesQty_SUM(){
    ensureRecentHeaderQty();
    const minQty = Math.max(0, Math.floor(Number(document.getElementById('d-min-qty')?.value||0)));
    const invs = (read && read('invoices',[])) || [];
    const show = invs.filter(inv => qtySum(inv) >= minQty);
    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = document.getElementById('d-inv-count');
    if (!tbody) return;
    function money(n){ return '$ ' + (Math.round((Number(n)||0)*100)/100).toFixed(2); }

    tbody.innerHTML = show.map((i,idx)=>{
      const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
      const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
      const q = qtySum(i);
      return `<tr>
        <td>${idx+1}</td>
        <td>${new Date(i.datetime || (i.date? (i.date+'T00:00:00'): Date.now())).toLocaleString()}</td>
        <td>${i.invNo||''}</td>
        <td>${i.customer||''}</td>
        <td>${i.seller||''}</td>
        <td>${i.branch||''}</td>
        <td class="right">${q}</td>
        <td class="right">${money(i.profit||0)}</td>
        <td class="right">${status}</td>
      </tr>`;
    }).join('') || '<tr><td colspan="9">No data</td></tr>';

    if (countEl) countEl.textContent = `${show.length} found`;
  }
  // Wire Qty Apply button (from v3 patch)
  (function wireRecentQty(){
    const btn = document.getElementById('d-apply-qty');
    if (btn && !btn._wired_qty_sum){
      btn._wired_qty_sum = true;
      btn.onclick = renderRecentInvoicesQty_SUM;
    }
  })();

  // --- Invoices page ---
  function setInvoicesHeader(){
    const thead = document.querySelector('#inv-table thead tr');
    if (!thead) return;
    thead.innerHTML = `
      <th>#</th>
      <th>·ûê·üí·ûÑ·üÉ·ûÅ·üÇ</th>
      <th>No.</th>
      <th>·û¢·üí·ûì·ûÄ·ûõ·ûÄ·üã</th>
      <th>·ûü·û∂·ûÅ·û∂</th>
      <th class="right">·ûÖ·üÜ·ûì·ûΩ·ûì</th>
      <th class="right">·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ</th>
      <th class="right">Total</th>
      <th class="right">·ûî·û∂·ûì·ûî·ûÑ·üã</th>
      <th class="right">·ûì·üÖ·ûü·ûõ·üã</th>
      <th>Action</th>
    `;
  }

  if (typeof renderInvoices === 'function' && !renderInvoices._qty_sum_patched){
    const _renderInvoices = renderInvoices;
    window.renderInvoices = function(){
      try { _renderInvoices(); } catch(e){}
      setInvoicesHeader();

      const invsRaw = read('invoices',[]) || [];
      const invs = invsRaw.map(i => (i && i.datetime ? i : {...i, datetime: (i.date? new Date(i.date+'T00:00:00').toISOString(): new Date().toISOString()) }));

      // Apply same filters and sort as original
      const statusSel = document.getElementById('inv-status');
      const q = (document.getElementById('inv-search')?.value || '').toLowerCase();
      let show = invs.slice();
      if (window.INV_FILTER && window.INV_FILTER !== 'ALL'){
        show = show.filter(i => (i.invType||'SALE') === window.INV_FILTER);
      }
      const statusVal = statusSel ? statusSel.value : 'ALL';
      if (statusVal !== 'ALL'){
        show = show.filter(i => (i.status || ((i.balance||0)>0?'UNPAID':'PAID')) === statusVal);
      }
      if (q){
        show = show.filter(i => {
          const hay = ( (i.invNo||'')+' '+(i.customer||'')+' '+(i.customer_phone||'')+' '+(i.seller||'')+' '+(i.branch||'')+' '+(i.notes||'') ).toLowerCase();
          return hay.includes(q);
        });
      }
      const S = window.INV_SORT || {by:'date', dir:'desc'};
      show.sort((a,b)=>{
        const dir = (S.dir==='asc') ? 1 : -1;
        switch (S.by){
          case 'total': return dir*((a.total||0)-(b.total||0));
          case 'status': return dir*((a.status||'').localeCompare(b.status||''));
          default: return dir*(new Date(a.datetime)-new Date(b.datetime));
        }
      });

      const tbody = document.querySelector('#inv-table tbody');
      if (!tbody) return;
      tbody.innerHTML = show.map((i,idx)=>{
        const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
        const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
        const qsum = qtySum(i);
        return `<tr>
          <td>${idx+1}</td>
          <td>${new Date(i.datetime).toLocaleString()}</td>
          <td>${i.invNo||''}</td>
          <td>${i.seller||''}</td>
          <td>${i.branch||''}</td>
          <td class="right">${qsum}</td>
          <td class="right">${status}</td>
          <td class="right">$ ${(i.total||0).toFixed(2)}</td>
          <td class="right">$ ${(i.paid||0).toFixed(2)}</td>
          <td class="right">$ ${bal.toFixed(2)}</td>
          <td>
            <button class="btn ghost" data-print="${i.id}">Print</button>
            <button class="btn ghost" data-paid="${i.id}">Mark Paid</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="11">No data</td></tr>';

      tbody.querySelectorAll('[data-print]').forEach(b=> b.onclick=()=> printInvoice(b.dataset.print));
      tbody.querySelectorAll('[data-view]').forEach(b=> b.onclick=()=> viewInvoice(b.dataset.view));
  tbody.querySelectorAll('[data-paid]').forEach(b=> b.onclick=()=> openMarkPaidModal(b.dataset.paid));
    };
    renderInvoices._qty_sum_patched = true;
  }

  // Apply once on tab switch too
  document.querySelectorAll('.tab[data-view="invoices"]').forEach(btn=>{
    if (btn._qty_sum_hdr) return;
    btn._qty_sum_hdr = true;
    btn.addEventListener('click', ()=> setTimeout(setInvoicesHeader, 30));
  });

  // Initial boot
  setTimeout(()=>{
    ensureRecentHeaderQty();
    setInvoicesHeader();
  }, 50);
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Dashboard Recent Invoices: enforce Qty = SUM(item.qty) on every refresh -->
<script>
(function(){
  function qtySum(inv){
    const items = Array.isArray(inv.items) ? inv.items : [];
    return items.reduce((s,it)=> s + (Number(it.qty)||0), 0);
  }
  function mapInvByNo(){
    const invs = (read && read('invoices',[])) || [];
    const m = new Map();
    invs.forEach(i => { if (i && i.invNo) m.set(String(i.invNo), i); });
    return m;
  }
  function setRecentHeaderToQty(){
    const tr = document.querySelector('#d-invoices thead tr');
    if (!tr) return;
    tr.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }
  function enforceRecentQty(){
    const table = document.getElementById('d-invoices');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    const invMap = mapInvByNo();
    [...tbody.rows].forEach(row => {
      // Expected columns after our header: 0#,1Date,2No,3Customer,4Seller,5Branch,6Qty,7Profit,8Status
      const noCell = row.cells && row.cells[2];
      const qtyCell = row.cells && row.cells[6];
      if (!noCell || !qtyCell) return;
      const invNo = (noCell.textContent||'').trim();
      const inv = invMap.get(invNo);
      if (!inv) return;
      qtyCell.textContent = String(qtySum(inv));
      qtyCell.classList.add('right');
    });
  }
  function hookRecent(){
    setRecentHeaderToQty();
    enforceRecentQty();
    // Re-apply after any dashboard filter action
    const ids = ['d-apply', 'd-clear'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if (el && !el._recent_qty_fix){
        el._recent_qty_fix = true;
        el.addEventListener('click', ()=> setTimeout(()=>{ setRecentHeaderToQty(); enforceRecentQty(); }, 30));
      }
    });
  }
  // Run now, and on dashboard init
  hookRecent();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      setTimeout(hookRecent, 50);
    };
  }
  // Also when switching to Dashboard tab
  document.querySelectorAll('.tab[data-view="dashboard"]').forEach(btn=>{
    if (btn._recent_qty_fix) return;
    btn._recent_qty_fix = true;
    btn.addEventListener('click', ()=> setTimeout(hookRecent, 50));
  });
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Dashboard Recent Invoices: totals row for Qty + Profit -->
<script>
(function(){
  function ensureRecentHeader(){
    const tr = document.querySelector('#d-invoices thead tr');
    if (!tr) return;
    // Expected columns: #, Date/Time, No., Customer, Seller, Branch, Qty, Profit, Status
    tr.innerHTML = `
      <th>#</th>
      <th>Date/Time</th>
      <th>No.</th>
      <th>Customer</th>
      <th>Seller</th>
      <th>Branch</th>
      <th class="right">Qty</th>
      <th class="right">Profit</th>
      <th class="right">Status</th>
    `;
  }
  function ensureRecentFooter(){
    const tbl = document.getElementById('d-invoices');
    if (!tbl) return;
    let tf = tbl.querySelector('tfoot');
    if (!tf){
      tf = document.createElement('tfoot');
      tf.id = 'd-invoices-foot';
      tf.innerHTML = `
        <tr>
          <td colspan="6" class="right"><b>Total</b></td>
          <td class="right" id="d-inv-total-qty">0</td>
          <td class="right" id="d-inv-total-profit">$ 0.00</td>
          <td></td>
        </tr>
      `;
      tbl.appendChild(tf);
    }
  }
  function parseMoney(s){
    const n = String(s||'').replace(/[^\d.\-]/g,'').trim();
    const v = parseFloat(n);
    return isNaN(v) ? 0 : v;
  }
  function recomputeRecentTotals(){
    const tbl = document.getElementById('d-invoices');
    if (!tbl) return;
    const tbody = tbl.querySelector('tbody');
    if (!tbody) return;
    let qtySum = 0;
    let profitSum = 0;
    [...tbody.rows].forEach(row => {
      // columns: 0#,1Date,2No,3Customer,4Seller,5Branch,6Qty,7Profit,8Status
      const qtyCell = row.cells && row.cells[6];
      const profCell = row.cells && row.cells[7];
      if (qtyCell) qtySum += Number(qtyCell.textContent||0);
      if (profCell) profitSum += parseMoney(profCell.textContent||0);
    });
    const qtyEl = document.getElementById('d-inv-total-qty');
    const proEl = document.getElementById('d-inv-total-profit');
    if (qtyEl) qtyEl.textContent = String(qtySum);
    if (proEl) proEl.textContent = '$ ' + (Math.round(profitSum*100)/100).toFixed(2);
  }

  function hookRecentTotals(){
    ensureRecentHeader();
    ensureRecentFooter();
    recomputeRecentTotals();
    // Recompute after filter/apply/clear
    ['d-apply','d-clear'].forEach(id=>{
      const el = document.getElementById(id);
      if (el && !el._recent_totals){
        el._recent_totals = true;
        el.addEventListener('click', ()=> setTimeout(()=>{
          ensureRecentFooter();
          recomputeRecentTotals();
        }, 30));
      }
    });
  }

  // Run now and on dashboard init/tab switch
  hookRecentTotals();
  if (typeof initDashboard==='function'){
    const _initDashboard = initDashboard;
    window.initDashboard = function(){
      _initDashboard && _initDashboard();
      setTimeout(hookRecentTotals, 50);
    };
  }
  document.querySelectorAll('.tab[data-view="dashboard"]').forEach(btn=>{
    if (btn._recent_totals) return;
    btn._recent_totals = true;
    btn.addEventListener('click', ()=> setTimeout(hookRecentTotals, 50));
  });
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>

<!-- Dashboard Filters ‚Äî working Apply/Clear -->
<script>
(function(){
  // Helper to read localStorage namespace used by the app
  const NS = 'sa_clean_v1_';
  const K = (k)=> NS+k;
  const read = (k,f)=>{ try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
  const write=(k,v)=>localStorage.setItem(K(k), JSON.stringify(v));
  const byId = (id)=>document.getElementById(id);

  // Remember fields with data-remember
  function initRemember(){
    document.querySelectorAll('[data-remember]').forEach(el=>{
      const key = 'remember_'+el.id;
      const saved = read(key, null);
      if (saved !== null && saved !== undefined) el.value = saved;
      if (!el._remember_wired){
        el._remember_wired = true;
        el.addEventListener('input', ()=> write(key, el.value));
        el.addEventListener('change', ()=> write(key, el.value));
      }
    });
  }

  function inRange(iso, from, to){
    if (!iso && !from && !to) return true;
    const t = iso ? new Date(iso) : new Date();
    if (from){
      const f = new Date(from + 'T00:00:00');
      if (t < f) return false;
    }
    if (to){
      const e = new Date(to + 'T23:59:59');
      if (t > e) return false;
    }
    return true;
  }

  function matchInvoice(i){
    const from = byId('d-from')?.value || '';
    const to = byId('d-to')?.value || '';
    const type = (byId('d-type')?.value || 'ALL').toUpperCase();
    const branch = (byId('d-branch')?.value || '').toLowerCase();
    const seller = (byId('d-seller')?.value || '').toLowerCase();
    const customer = (byId('d-customer')?.value || '').toLowerCase();
    const pkw = (byId('d-product')?.value || '').toLowerCase();

    const dt = i.datetime || (i.date ? (i.date+'T00:00:00') : null);
    if (!inRange(dt, from, to)) return false;
    if (type !== 'ALL' && String((i.invType||i.type||'')).toUpperCase() !== type) return false;
    if (branch && !String(i.branch||'').toLowerCase().includes(branch)) return false;
    if (seller && !String(i.seller||'').toLowerCase().includes(seller)) return false;

    if (customer){
      const hay = (String(i.customer||'') + ' ' + String(i.customer_phone||'') + ' ' + String(i.customer_location||'')).toLowerCase();
      if (!hay.includes(customer)) return false;
    }
    if (pkw){
      const items = Array.isArray(i.items) ? i.items : [];
      const ok = items.some(it => (String(it.name||'')+' '+String(it.productId||'')+' '+String(it.barcode||'')).toLowerCase().includes(pkw));
      if (!ok) return false;
    }
    return true;
  }

  function money(n){ n = Number(n)||0; return '$ ' + (Math.round(n*100)/100).toFixed(2); }

  function renderFrom(filtered){
    // --- Recent Invoices ---
    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = byId('d-inv-count');
    if (tbody){
      const show = filtered.slice().sort((a,b)=> new Date(b.datetime||b.date||0) - new Date(a.datetime||a.date||0)).slice(0,200);
      tbody.innerHTML = show.map((i,idx)=>{
        const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
        const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
        return `<tr>
          <td>${idx+1}</td>
          <td>${new Date(i.datetime || (i.date? (i.date+'T00:00:00') : Date.now())).toLocaleString()}</td>
          <td>${i.invNo||''}</td>
          <td>${i.customer||''}</td>
          <td>${i.seller||''}</td>
          <td>${i.branch||''}</td>
          <td class="right">${money(i.total||0)}</td>
          <td class="right">${money(i.profit||0)}</td>
          <td class="right">${status}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="9">No data</td></tr>';
      if (countEl) countEl.textContent = filtered.length + ' found';

      // Sums (Total Sales, Total Profit) based on filtered set
      const totals = filtered.reduce((acc,i)=>{
        acc.sales += Number(i.total||0);
        acc.profit += Number(i.profit||0);
        return acc;
      }, {sales:0, profit:0});
      const sumsEl = byId('d-inv-sums');
      if (sumsEl){
        const sales = '$ ' + (Math.round(totals.sales*100)/100).toFixed(2);
        const prof  = '$ ' + (Math.round(totals.profit*100)/100).toFixed(2);
        sumsEl.innerHTML = `<b>Total Sales:</b> ${sales} &nbsp; ¬∑ &nbsp; <b>Total Profit:</b> ${prof}`;
      }
    }

    // --- Top Products (from filtered invoices) ---
    const topBody = document.querySelector('#d-top tbody');
    if (topBody){
      const agg = {};
      filtered.forEach(inv => (inv.items||[]).forEach(it => {
        const k = it.name || it.productId || '(No name)';
        if (!agg[k]) agg[k] = {qty:0, sales:0, profit:0};
        agg[k].qty += Number(it.qty||0);
        // prefer explicit fields; fallback to qty*price
        const sales = (it.amount!=null? Number(it.amount) : (it.total!=null? Number(it.total): (Number(it.qty||0)*Number(it.price||0))));
        const profit = (it.profit!=null? Number(it.profit) : (Number(it.qty||0)*(Number(it.price||0)-Number(it.baseline||0))));
        agg[k].sales += Number(sales||0);
        agg[k].profit += Number(profit||0);
      }));
      const rows = Object.entries(agg).sort((a,b)=> b[1].sales - a[1].sales).slice(0,20)
        .map(([name,v])=> `<tr><td>${name}</td><td class="right">${v.qty}</td><td class="right">${money(v.sales)}</td><td class="right">${money(v.profit)}</td></tr>`)
        .join('');
      topBody.innerHTML = rows || '<tr><td colspan="4">No data</td></tr>';
      const tc = byId('d-top-count'); if (tc) tc.textContent = Object.keys(agg).length;
    }

    // --- Stock Alerts (unchanged ‚Äì uses current product list and thresholds) ---
    const stockBody = document.querySelector('#d-stock tbody');
    if (stockBody){
      const products = read('products',[]) || [];
      const rows = products.filter(p => Number(p.qty||0) <= Number(p.low_threshold ?? read('low_threshold',5)))
        .sort((a,b)=> (a.qty||0) - (b.qty||0))
        .map(p => `<tr><td>${p.name}</td><td class="right">${p.qty||0}</td></tr>`).join('');
      stockBody.innerHTML = rows || '<tr><td colspan="2">No low stock</td></tr>';
    }

    // --- Totals (Filtered) KPI bar ---
    const sumSalesEl = byId('d-sum-sales');
    const sumProfitEl = byId('d-sum-profit');
    if (sumSalesEl && sumProfitEl){
      const totals = filtered.reduce((acc,i)=>{
        acc.sales += Number(i.total||0);
        acc.profit += Number(i.profit||0);
        return acc;
      }, {sales:0, profit:0});
      sumSalesEl.textContent  = '$ ' + (Math.round(totals.sales*100)/100).toFixed(2);
      sumProfitEl.textContent = '$ ' + (Math.round(totals.profit*100)/100).toFixed(2);
    }
  }

  function computeAndRender(){
    const all = (read('invoices',[]) || []).map(i=> i && i.datetime ? i : {...i, datetime: (i.date? (i.date+'T00:00:00') : new Date().toISOString())});
    const filtered = all.filter(matchInvoice);
    renderFrom(filtered);
  }

  // Expose/override initDashboard ‚Äî preserve existing init (KPIs, QMI, etc.)
  const __prevInitDashboard = (typeof window.initDashboard==='function') ? window.initDashboard : null;
  window.initDashboard = function(){
    __prevInitDashboard && __prevInitDashboard();
    try {
      initRemember();
      // Wire buttons once
      const applyBtn = byId('d-apply');
      const clearBtn = byId('d-clear');
      if (applyBtn && !applyBtn._wired){
        applyBtn._wired = true;
        applyBtn.addEventListener('click', computeAndRender);
      }
      if (clearBtn && !clearBtn._wired){
        clearBtn._wired = true;
        clearBtn.addEventListener('click', function(){
          document.querySelectorAll('[data-remember]').forEach(el=>{
            el.value = (el.tagName==='SELECT' ? (el.id==='d-type' ? 'ALL' : '') : '');
            write('remember_'+el.id, el.value);
          });
          // Ensure Type resets to ALL
          if (byId('d-type')){ byId('d-type').value = 'ALL'; write('remember_d-type','ALL'); }
          computeAndRender();
        });
      }
      // initial paint
      computeAndRender();
    } catch(e){ console.error('initDashboard (filters) failed', e); }
  };
})();

/* === QMI Enhancements: rebuild card, add export/filter/delete, and logic === */
(function(){
  function ensureQmiCard() {
    var card = document.getElementById('quick-money');
    if (!card) return;
    // Build new inner content
    card.innerHTML = [
      '<h3 style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center;">',
      '  <span>üí∞ Quick Money-in</span>',
      '  <span class="row gap">',
      '    <button id="qmi-export" class="btn ghost">‚¨áÔ∏è Export CSV</button>',
      '    <button id="qmi-clear" class="btn danger ghost">üóëÔ∏è Clear History</button>',
      '  </span>',
      '</h3>',
      '<div class="row gap" style="margin-bottom:10px;">',
      '  <select id="qmi-dest" class="input" style="min-width:120px;">',
      '    <option value="CASH">CASH</option>',
      '    <option value="ABA">ABA</option>',
      '    <option value="ACLEDA">ACLEDA</option>',
      '  </select>',
      '  <select id="qmi-curr" class="input" style="min-width:120px;">',
      '    <option value="KHR">KHR (·üõ)</option>',
      '    <option value="USD">USD ($)</option>',
      '  </select>',
      '  <input id="qmi-amount" class="input" type="number" step="0.01" min="0" placeholder="Amount"/>',
      '  <input id="qmi-note" class="input" placeholder="Note (optional)" style="flex:1;"/>',
      '  <button id="qmi-add" class="btn">‚ûï Add</button>',
      '</div>',
      '<div class="small muted">Quick record of money-in to Cash or Bank.</div>',
      '<div class="row gap no-print" style="margin:10px 0;">',
      '  <label class="small">From <input id="qmi-from" type="date" class="input sm"></label>',
      '  <label class="small">To <input id="qmi-to" type="date" class="input sm"></label>',
      '  <label class="small">Method',
      '    <select id="qmi-method" class="input sm">',
      '      <option value="ALL">ALL</option>',
      '      <option value="CASH">CASH</option>',
      '      <option value="ABA">ABA</option>',
      '      <option value="ACLEDA">ACLEDA</option>',
      '    </select>',
      '  </label>',
      '  <button id="qmi-export-filtered" class="btn ghost">‚¨áÔ∏è Export (Filtered)</button>',
      '  <label class="small">Delete &lt;= <input id="qmi-del-date" type="date" class="input sm"></label>',
      '  <button id="qmi-delete-before" class="btn danger ghost">üóëÔ∏è Delete Before</button>',
      '</div>',
      '<div id="qmi-balances" class="row gap" style="margin-top:10px;"></div>',
      '<table class="table" style="margin-top:6px;">',
      '  <thead><tr><th>Date/Time</th><th>Type</th><th>Method</th><th class="right">Amount</th><th>Note</th></tr></thead>',
      '  <tbody id="qmi-table"></tbody>',
      '</table>'
    ].join('');
  }

  // LocalStorage helpers (reuse if existing)
  var NS = (typeof NS !== 'undefined') ? NS : 'sa_clean_v1_';
  function K(k){ return NS + k; }
  function read(k,f){ try { return JSON.parse(localStorage.getItem(K(k)) || JSON.stringify(f)); } catch(e){ return f; } }
  function write(k,v){ localStorage.setItem(K(k), JSON.stringify(v)); }
  function uid(){ return Math.random().toString(36).slice(2); }
  function toast(msg){
    var t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t);
    setTimeout(function(){ t.classList.add('show'); },10);
    setTimeout(function(){ t.classList.remove('show'); setTimeout(function(){ t.remove(); },200); },2000);
  }

  // QMI data helpers
  var QMI_KEY = 'qmi';
  function qmiRead(){ return read(QMI_KEY, []); }
  function qmiWrite(v){ write(QMI_KEY, v); }

  function renderQMI(){
    var rows = qmiRead().slice().sort(function(a,b){ return new Date(b.dt)-new Date(a.dt); });
    var bal = { CASH_KHR:0, CASH_USD:0, ABA_KHR:0, ABA_USD:0, ACLEDA_KHR:0, ACLEDA_USD:0 };
    rows.forEach(function(r){
      var key = (r.method||'') + '_' + (r.curr||''); if (bal.hasOwnProperty(key)) bal[key] += Number(r.amount||0);
    });

    var b = document.getElementById('qmi-balances');
    if (b){
      b.innerHTML = '';
      [
        ['ABA_KHR','ABA (·üõ)'],['ABA_USD','ABA ($)'],
        ['ACLEDA_KHR','ACLEDA (·üõ)'],['ACLEDA_USD','ACLEDA ($)'],
        ['CASH_KHR','CASH (·üõ)'],['CASH_USD','CASH ($)']
      ].forEach(function(item){
        var k=item[0], label=item[1];
        var div=document.createElement('div'); div.className='chip';
        var val = (Math.round((bal[k]||0)*100)/100).toFixed(2);
        div.textContent = label + ' ' + val; b.appendChild(div);
      });
    }

    var tb = document.getElementById('qmi-table');
    if (tb){
      tb.innerHTML = rows.map(function(r){
        var amt = (Math.round((r.amount||0)*100)/100).toFixed(2);
        var note = (r.note||'').replace(/</g,'&lt;');
        return '<tr>' +
          '<td>' + new Date(r.dt).toLocaleString() + '</td>' +
          '<td>' + (r.curr||'') + '</td>' +
          '<td>' + (r.method||'') + '</td>' +
          '<td class="right">' + amt + '</td>' +
          '<td>' + note + '</td>' +
        '</tr>';
      }).join('') || '<tr><td colspan="5">No data</td></tr>';
    }
  }

  function addQMI(){
    var dest = (document.getElementById('qmi-dest').value||'CASH').toUpperCase();
    var curr = (document.getElementById('qmi-curr').value||'KHR').toUpperCase();
    var amt  = Number(document.getElementById('qmi-amount').value||0);
    var note = (document.getElementById('qmi-note').value||'').trim();
    if (amt<=0){ toast('Enter amount'); return; }
    var rec = { id: uid(), dt: new Date().toISOString(), method: dest, curr: curr, amount: Math.round(amt*100)/100, note: note };
    var data = qmiRead(); data.push(rec); qmiWrite(data);
    document.getElementById('qmi-amount').value=''; document.getElementById('qmi-note').value='';
    renderQMI(); toast('Added ‚úî');
  }

  function clearQMI(){
    if (!confirm('·ûõ·ûª·ûî·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô Quick Money-in ·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã?')) return;
    qmiWrite([]); renderQMI(); toast('Cleared ‚úî');
  }

  function exportQMIToCSV(){
    var rows = qmiRead();
    if (!rows.length){ toast('·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô'); return; }
    var header = ['DateTime','Type','Method','Amount','Note'];
    function esc(s){ var t = String(s==null?'':s); return /[",\n]/.test(t) ? '"' + t.replace(/"/g,'""') + '"' : t; }
    var lines = [header.join(',')];
    rows.forEach(function(r){
      lines.push([
        new Date(r.dt).toLocaleString(),
        r.curr||'',
        r.method||'',
        (Math.round((r.amount||0)*100)/100).toFixed(2),
        r.note||''
      ].map(esc).join(','));
    });
    var csv = lines.join('\n');
    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var a = document.createElement('a');
    var ymd = new Date().toISOString().slice(0,10).replace(/-/g,'');
    a.href = URL.createObjectURL(blob);
    a.download = 'quick_money_in_' + ymd + '.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    toast('Exported CSV ‚úî');
  }

  // Filter helpers
  function inRange(dtISO, fromStr, toStr){
    var t = new Date(dtISO).getTime();
    if (isNaN(t)) return false;
    var ok = true;
    if (fromStr){ ok = ok && (t >= new Date(fromStr+'T00:00:00').getTime()); }
    if (toStr){   ok = ok && (t <= new Date(toStr+'T23:59:59').getTime()); }
    return ok;
  }
  function methodMatch(method, want){ return want==='ALL' ? true : (String(method||'').toUpperCase()===String(want||'').toUpperCase()); }

  function exportQMIFiltered(){
    var from = (document.getElementById('qmi-from').value||'').trim();
    var to   = (document.getElementById('qmi-to').value||'').trim();
    var m    = (document.getElementById('qmi-method').value||'ALL').toUpperCase();
    var rows = qmiRead().filter(function(r){ return inRange(r.dt, from, to) && methodMatch(r.method, m); });
    if (!rows.length){ toast('No data for this filter'); return; }

    var header = ['DateTime','Type','Method','Amount','Note'];
    function esc(s){ var t = String(s==null?'':s); return /[",\n]/.test(t) ? '"' + t.replace(/"/g,'""') + '"' : t; }
    var lines = [header.join(',')];
    rows.forEach(function(r){
      lines.push([
        new Date(r.dt).toLocaleString(),
        r.curr||'',
        r.method||'',
        (Math.round((r.amount||0)*100)/100).toFixed(2),
        r.note||''
      ].map(esc).join(','));
    });
    var blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    var a = document.createElement('a');
    var tag = (from||'start') + '_' + (to||'end') + '_' + (m.toLowerCase());
    a.href = URL.createObjectURL(blob);
    a.download = 'quick_money_in_' + tag + '.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
    toast('Exported CSV ‚úî');
  }

  function deleteQMIBefore(){
    var d = (document.getElementById('qmi-del-date').value||'').trim();
    if (!d){ toast('Pick a date'); return; }
    if (!confirm('·ûõ·ûª·ûî·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô Quick Money-in ·ûò·ûª·ûì·û¨·ûü·üí·ûò·ûæ ' + d + ' ?')) return;
    var cut = new Date(d+'T23:59:59').getTime();
    var kept = qmiRead().filter(function(r){ return new Date(r.dt).getTime() > cut; });
    qmiWrite(kept); renderQMI(); toast('Deleted old records ‚úî');
  }

  function wireQmi(){
    var addBtn = document.getElementById('qmi-add');
    var clrBtn = document.getElementById('qmi-clear');
    var expBtn = document.getElementById('qmi-export');
    var exf    = document.getElementById('qmi-export-filtered');
    var delb   = document.getElementById('qmi-delete-before');
    if (addBtn && !addBtn._bound){ addBtn.onclick = addQMI; addBtn._bound = true; }
    if (clrBtn && !clrBtn._bound){ clrBtn.onclick = clearQMI; clrBtn._bound = true; }
    if (expBtn && !expBtn._bound){ expBtn.onclick = exportQMIToCSV; expBtn._bound = true; }
    if (exf && !exf._bound){ exf.onclick = exportQMIFiltered; exf._bound = true; }
    if (delb && !delb._bound){ delb.onclick = deleteQMIBefore; delb._bound = true; }
  }

  function initQmi(){
    ensureQmiCard();
    wireQmi();
    renderQMI();
  }

  // Run after DOM load. If app uses tab switching, also re-init when entering dashboard view.
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQmi);
  } else {
    initQmi();
  }

  // If the app has tabs with [data-view="dashboard"], hook into tab click to re-init.
  try {
    document.querySelectorAll('.tab').forEach(function(btn){
      btn.addEventListener('click', function(){
        if (btn.dataset.view === 'dashboard') {
          setTimeout(initQmi, 0);
        }
      });
    });
  } catch(e){}
})();


// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>
<script>
// === QMI: auto-log from Mark Paid & render balances ===
(function(){
  const NS = 'sa_clean_v1_';
  const K = (k)=> NS+k;
  const read = (k,f)=>{ try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
  const write=(k,v)=>localStorage.setItem(K(k), JSON.stringify(v));
  const money = (n)=>'$ '+(Math.round((Number(n)||0)*100)/100).toFixed(2);
  const uid = ()=> Math.random().toString(36).slice(2);

  window.__qmi = window.__qmi || {};
  __qmi.readAll = ()=> read('qmi',[]) || [];
  __qmi.push = (rec)=>{ const q = __qmi.readAll(); q.unshift(rec); write('qmi', q); return q; };

  const QMI_METHOD_MAP = {
    'CASH_USD': { type: 'IN', dest: 'CASH', curr: 'USD' },
    'CASH_KHR': { type: 'IN', dest: 'CASH', curr: 'KHR' },
    'BANK_ABA_USD': { type: 'IN', dest: 'ABA', curr: 'USD' },
    'BANK_ABA_KHR': { type: 'IN', dest: 'ABA', curr: 'KHR' },
    'BANK_ACLEDA_USD': { type: 'IN', dest: 'ACLEDA', curr: 'USD' },
    'BANK_ACLEDA_KHR': { type: 'IN', dest: 'ACLEDA', curr: 'KHR' },
    'MOBILE_MONEY': { type: 'IN', dest: 'MOMO', curr: 'USD' },
    'OTHER': { type: 'IN', dest: 'OTHER', curr: 'USD' },
  };

  function qmiFromPayment(inv, p){
    const map = QMI_METHOD_MAP[p.method] || null;
    if (!map || !p.amount) return null;
    return {
      id: uid(),
      date: new Date().toISOString(),
      type: map.type,
      dest: map.dest,
      curr: map.curr,
      amount: Number(p.amount)||0,
      note: `Mark Paid ‚Ä¢ ${inv.invNo||inv.id||''}`
    };
  }

  window.logQmiFromInvoice = function(inv){
    if (!inv || !Array.isArray(inv.payments)) return;
    const payloads = inv.payments.map(p=> qmiFromPayment(inv, p)).filter(Boolean);
    if (!payloads.length) return;
    const q = __qmi.readAll();
    payloads.forEach(rec=> q.unshift(rec));
    write('qmi', q);
    try{ renderQmi && renderQmi(); }catch(e){}
  };

  function sumBalances(){
    const q = __qmi.readAll();
    const accs = ['CASH','ABA','ACLEDA'];
    const currs = ['USD','KHR'];
    const sums = { totalByAcc:{}, totalByCurr:{USD:0, KHR:0} };
    accs.forEach(a=> sums.totalByAcc[a] = { USD:0, KHR:0 });
    q.forEach(r=>{
      const sign = (r.type==='IN') ? 1 : -1;
      if (sums.totalByAcc[r.dest]){
        sums.totalByAcc[r.dest][r.curr] += sign * (Number(r.amount)||0);
      }
      if (sums.totalByCurr[r.curr] !== undefined){
        sums.totalByCurr[r.curr] += sign * (Number(r.amount)||0);
      }
    });
    for (const a of Object.keys(sums.totalByAcc)){
      for (const c of Object.keys(sums.totalByAcc[a])){
        sums.totalByAcc[a][c] = Math.round(sums.totalByAcc[a][c]*100)/100;
      }
    }
    for (const c of Object.keys(sums.totalByCurr)){
      sums.totalByCurr[c] = Math.round(sums.totalByCurr[c]*100)/100;
    }
    return sums;
  }

  window.renderQmi = function(){
    const sums = sumBalances();
    const wrap = document.getElementById('qmi-balances');
    if (wrap){
      wrap.innerHTML = '';
      ['ABA','ACLEDA','CASH'].forEach(acc=>{
        const usd = sums.totalByAcc[acc].USD || 0;
        const khr = sums.totalByAcc[acc].KHR || 0;
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = `${acc} ($) ${usd.toFixed(2)}  ‚Ä¢  ${acc} (·üõ) ${khr.toFixed(2)}`;
        wrap.appendChild(chip);
      });
      const sumChip = document.createElement('div');
      sumChip.className = 'chip';
      sumChip.textContent = `Total ($) ${sums.totalByCurr.USD.toFixed(2)}  ‚Ä¢  Total (·üõ) ${sums.totalByCurr.KHR.toFixed(2)}`;
      wrap.appendChild(sumChip);
    }
    const tbody = document.getElementById('qmi-table');
    if (tbody){
      const rows = __qmi.readAll().map(r=> 
        `<tr><td>${new Date(r.date).toLocaleString()}</td><td>${r.type}</td><td>${r.dest} ${r.curr}</td><td class="right">${money(r.amount)}</td><td>${r.note||''}</td></tr>`
      ).join('');
      tbody.innerHTML = rows || '<tr><td colspan="5" class="muted">No records</td></tr>';
    }
  };

  const _openMarkPaidModal = window.openMarkPaidModal;
  if (typeof _openMarkPaidModal === 'function' && !_openMarkPaidModal._qmiWrapped){
    window.openMarkPaidModal = function(invId){
      _openMarkPaidModal.call(this, invId);
      const btn = document.getElementById('m-save');
      if (btn && !btn._qmiBound){
        const orig = btn.onclick;
        btn.onclick = function(){
          const before = read('invoices',[]);
          if (typeof orig === 'function') orig();
          const after = read('invoices',[]);
          const inv = after.find(x=> x.id===invId);
          if (inv && inv.status==='PAID'){
            window.logQmiFromInvoice(inv);
          }
          try{ renderQmi(); }catch{}
        };
        btn._qmiBound = true;
      }
    };
    window.openMarkPaidModal._qmiWrapped = true;
  }

  try{ renderQmi(); }catch(e){}

})();
</script>

<script>
// === Auto Refresh Quick Money Without F5 ===
document.addEventListener("click", function(e){
  const tab = e.target.closest(".tab[data-view='dashboard']");
  if(tab){
    if(typeof renderQmi === "function"){ renderQmi(); }
  }
});

// Also refresh immediately after saving invoice
document.addEventListener("invoice-saved", function(){
  if(typeof renderQmi === "function"){ renderQmi(); }
});
</script>

<script>
// === Recent Invoices: add Qty totals (no refresh needed) ===
(function(){
  const NS = 'sa_clean_v1_';
  const K  = (k)=> NS+k;
  const read=(k,f)=>{ try{return JSON.parse(localStorage.getItem(K(k))||JSON.stringify(f));}catch{return f;} };
  const money=(n)=>'$ '+(Math.round((Number(n)||0)*100)/100).toFixed(2);

  function withinRange(dt, fromStr, toStr){
    const t = new Date(dt).getTime();
    if(isNaN(t)) return false;
    let ok = true;
    if(fromStr){ ok = ok && (t >= new Date(fromStr+'T00:00:00').getTime()); }
    if(toStr){   ok = ok && (t <= new Date(toStr+'T23:59:59').getTime()); }
    return ok;
  }

  function invMatches(i, f){
    if(f.type && f.type!=='ALL' && (i.invType||'SALE')!==f.type) return false;
    if(f.branch && f.branch.trim() && (i.branch||'').toLowerCase().indexOf(f.branch.toLowerCase())===-1) return false;
    if(f.seller && f.seller.trim() && (i.seller||'').toLowerCase().indexOf(f.seller.toLowerCase())===-1) return false;
    if(f.customer && f.customer.trim()){
      const hay = ((i.customer||'')+' '+(i.customer_phone||'')).toLowerCase();
      if(hay.indexOf(f.customer.toLowerCase())===-1) return false;
    }
    if(f.product && f.product.trim()){
      const ok = (i.items||[]).some(it => ((it.name||'')+' '+(it.productId||'')).toLowerCase().indexOf(f.product.toLowerCase())!==-1);
      if(!ok) return false;
    }
    return true;
  }

  function qtyOf(i){
    return (i.items||[]).reduce((s,it)=> s + (Number(it.qty)||0), 0);
  }

  window.renderRecentInvoicesQty = function(){
    const invs = (read('invoices',[])||[]).map(i => i.datetime? i : {...i, datetime: (i.date? new Date(i.date+'T00:00:00').toISOString(): new Date().toISOString())});

    const f = {
      from: (document.getElementById('d-from')||{}).value || '',
      to: (document.getElementById('d-to')||{}).value || '',
      type: (document.getElementById('d-type')||{}).value || 'ALL',
      branch: (document.getElementById('d-branch')||{}).value || '',
      seller: (document.getElementById('d-seller')||{}).value || '',
      customer: (document.getElementById('d-customer')||{}).value || '',
      product: (document.getElementById('d-product')||{}).value || '',
    };

    let show = invs.filter(i => withinRange(i.datetime, f.from, f.to) && invMatches(i, f));
    // Sort newest first by datetime
    show.sort((a,b)=> new Date(b.datetime) - new Date(a.datetime));

    const tbody = document.querySelector('#d-invoices tbody');
    const countEl = document.getElementById('d-inv-count');
    const sumsEl  = document.getElementById('d-inv-sums');

    let totalSales = 0, totalProfit = 0, totalQty = 0;

    if(tbody){
      tbody.innerHTML = show.map((i,idx)=>{
        const bal = Math.max(0, (i.balance!=null? i.balance : ((i.total||0)-(i.paid||0))));
        const status = i.status || (bal>0 ? 'UNPAID' : 'PAID');
        const q = qtyOf(i);
        totalQty += q;
        totalSales += Number(i.total||0);
        totalProfit += Number(i.profit||0);
        return `<tr>
          <td>${idx+1}</td>
          <td>${new Date(i.datetime).toLocaleString()}</td>
          <td>${i.invNo||''}</td>
          <td>${i.customer||''}</td>
          <td>${i.seller||''}</td>
          <td>${i.branch||''}</td>
          <td class="right">${q}</td>
          <td class="right">$ ${(i.total||0).toFixed(2)}</td>
          <td class="right">$ ${(i.profit||0).toFixed(2)}</td>
          <td class="right">${status}</td>
        </tr>`;
      }).join('') || '<tr><td colspan="10">No data</td></tr>';
    }

    if(countEl){ countEl.textContent = (show.length||0) + ' found'; }
    if(sumsEl){
      sumsEl.innerHTML = `<b>Total Qty:</b> ${totalQty} &nbsp; ¬∑ &nbsp; <b>Total Sales:</b> ${money(totalSales)} &nbsp; ¬∑ &nbsp; <b>Total Profit:</b> ${money(totalProfit)}`;
    }
  };

  // Hook buttons (Apply / Clear) if present
  const applyBtn = document.getElementById('d-apply');
  if(applyBtn && !applyBtn._qtyBound){
    applyBtn.addEventListener('click', renderRecentInvoicesQty);
    applyBtn._qtyBound = true;
  }
  const clearBtn = document.getElementById('d-clear');
  if(clearBtn && !clearBtn._qtyBound){
    clearBtn.addEventListener('click', function(){
      ['d-from','d-to','d-type','d-branch','d-seller','d-customer','d-product'].forEach(id=>{
        const el=document.getElementById(id); if(!el) return;
        if(el.tagName==='SELECT'){ el.selectedIndex=0; } else { el.value=''; }
      });
      renderRecentInvoicesQty();
    });
    clearBtn._qtyBound = true;
  }

  // Re-render when switching to Dashboard tab
  document.addEventListener('click', function(e){
    const tab = e.target.closest(".tab[data-view='dashboard']");
    if(tab){ setTimeout(renderRecentInvoicesQty, 0); }
  });

  // Render on load (in case dashboard is default later)
  try{ renderRecentInvoicesQty(); }catch(e){}
})();
</script>
</body>
</html>

<script>
/* === QMI FIX PACK v1: migrate legacy rows & make Clear truly clear === */
(function(){
  var NS = (typeof NS !== 'undefined') ? NS : 'sa_clean_v1_';
  function K(k){ return NS + k; }

  function normalizeQmiRow(r){
    if (!r || typeof r!=='object') return null;
    var dt = r.dt || r.datetime || r.when || r.date || r.Date || r.time || '';
    var d = new Date(dt);
    if (isNaN(d.getTime())){
      if (r.date && r.time) d = new Date(String(r.date)+' '+String(r.time));
      else if (r.date) d = new Date(String(r.date));
      else d = new Date(); // fallback
    }
    var currRaw = (r.curr || r.currency || r.type || '').toString().toUpperCase();
    var curr = (currRaw==='USD'||currRaw==='KHR') ? currRaw 
              : (currRaw.indexOf('KHR')>=0 ? 'KHR' : (currRaw.indexOf('USD')>=0 || currRaw.indexOf('$')>=0 ? 'USD' : 'KHR'));
    var methodRaw = (r.method || r.dest || r.destination || r.account || '').toString().toUpperCase();
    var method = /ABA/.test(methodRaw) ? 'ABA' : (/ACLEDA/.test(methodRaw) ? 'ACLEDA' : 'CASH');
    var amount = Number((r.amount!=null?r.amount:(r.amt!=null?r.amt:(r.value!=null?r.value:(r.total!=null?r.total:0))))) || 0;
    var note = (r.note!=null?r.note:(r.notes!=null?r.notes:(r.remark!=null?r.remark:'')));
    return { dt: d.toISOString(), curr: curr, method: method, amount: Math.round(amount*100)/100, note: String(note) };
  }

  // Run migration if needed
  try{
    var raw = localStorage.getItem(K('qmi')) || '[]';
    var rows = JSON.parse(raw);
    var needFix = Array.isArray(rows) && rows.some(function(r){ return !(r && r.dt && r.curr && r.method); });
    if (needFix){
      var fixed = rows.map(normalizeQmiRow).filter(Boolean);
      localStorage.setItem(K('qmi'), JSON.stringify(fixed));
      if (!sessionStorage.getItem('qmi_migrated_once')){
        sessionStorage.setItem('qmi_migrated_once','1');
        setTimeout(function(){ try{ location.reload(); }catch(e){} }, 0);
      }
    }
  }catch(e){}

  // Make the "Clear History" more aggressive: also remove legacy keys then reload
  document.addEventListener('click', function(e){
    if (e && e.target && e.target.id === 'qmi-clear'){
      try{
        localStorage.removeItem(K('qmi'));
        localStorage.removeItem('qmi');                 // non-namespaced
        localStorage.removeItem(K('quick_money'));
        localStorage.removeItem(K('qmi_data'));
      }catch(err){}
      setTimeout(function(){ try{ location.reload(); }catch(e){} }, 0);
    }
  }, true);
})();

// View Invoice with attachments and note edit
function viewInvoice(invId){
  const list = read('invoices', []);
  const inv = list.find(x=>x.id===invId);
  if(!inv){ toast('Invoice not found'); return; }

  // Normalize attachments
  inv.payments = (inv.payments||[]).map(p=>{
    if(Array.isArray(p.attachments)) return p;
    if(p.attachment) return {...p, attachments:[p.attachment]};
    return {...p, attachments:[]};
  });

  const m = document.getElementById('modal-mask');
  document.getElementById('m-title').textContent = 'Invoice '+(inv.invNo||'');

  const paysHtml = inv.payments.map((p,pi)=>{
    const imgs = p.attachments.map((src,ai)=>`
      <div style="display:inline-block;position:relative;margin:4px;">
        <a href="${src}" target="_blank"><img src="${src}" style="max-width:120px;max-height:120px;border:1px solid var(--line);border-radius:8px"/></a>
      </div>`).join('') || '<span class="muted">No attachments</span>';
    return `<tr>
      <td>${p.method||''}</td>
      <td class="right">$ ${(p.amount||0).toFixed(2)}</td>
      <td>${p.note||''}</td>
      <td>${imgs}</td>
    </tr>`;
  }).join('');

  document.getElementById('m-body').innerHTML = `
    <div class="card light">
      <b>Payments</b>
      <table class="table" style="margin-top:6px">
        <thead><tr><th>Method</th><th class="right">Amount</th><th>Note</th><th>Attachments</th></tr></thead>
        <tbody>${paysHtml}</tbody>
      </table>
    </div>
  `;
  document.getElementById('m-save').textContent = 'Close';
  document.getElementById('m-save').onclick = ()=> m.classList.add('hidden');
  document.getElementById('m-cancel').style.display='none';
  m.classList.remove('hidden');
}

</script>
